\chapter{Integrality and valuation rings}

The notion of integrality is familiar from number theory: it is like
``algebraic'' but with monic polynomials. In algebraic geometry, integral
extensions of rings correspond to correspondingly nice morphisms on the
$\spec$'s---when the extension is finitely generated, it turns out that the
fibers are finite. That is, there are only finitely many ways to lift a prime
ideal to the extension.

Rings that are \emph{integrally closed} in their quotient field will play an
important role for us. Such ``normal domains'' are, for example, regular in
codimension one, which means that the theory of Weil divisors (\ref{}) applies
to them. It is particularly nice because Weil divisors are sufficient to
determine whether a function is regular on a normal variety.
A canonical example of an integrally closed ring is a valuation ring; we shall
see in this chapter that any integrally closed ring is an intersection of such.

\section{Integrality}

\subsection{Fundamentals}

Let us return to the ring $\mathbb{Z}[\sqrt{-5}]$; this is the canonical
example of a ring where unique factorization fails. This is because, as we
remember,
\[ 6 = 2 \times 3 = (1+\sqrt{-5})(1-\sqrt{-5}).  \]
Five is a big number; why did we have to go all the way to five to get this to
happen?
What about $\mathbb{Z}[\sqrt{-3}]$?

Here we have
\[ (1 - \sqrt{-3})(1+\sqrt{-3}) = 4 = 2 \times 2.  \]
These elements can be factored no more, and $1 - \sqrt{-3}$ and $2$ are not
associates (they differ by something which isn't a unit).
So in this ring, we have a failure of unique factorization. For some reason,
this doesn't bother people as much.

The reason this doesn't bother people is that $\mathbb{Z}[\sqrt{-3}]$ is
contained in the larger ring
\[ \mathbb{Z}[ \frac{1 + \sqrt{-3}}{2}],  \]
which does have unique factorization.

In fact, $\mathbb{Z}[\sqrt{-3}]$ is an index two subgroup of the larger ring.  
The reason is that the larger ring $\mathbb{Z}[ \frac{1 + \sqrt{-3}}{2}]$ can be described by the set of elements $a +
b\sqrt{-3}$ where $a,b$ are either both integers or both integers plus
$\frac{1}{2}$, as is easily seen: this set is closed under addition and
multiplication.  
Note that, by contrast, $\mathbb{Z}[ \frac{1 + \sqrt{-5}}{2}]$ does not
contain $\mathbb{Z}[\sqrt{-5}]$ as a finite index subgroup---it can't be
slightly enlarged in the same sense. When you enlarge $\mathbb{Z}[\sqrt{-5}]$,
you have to add a lot of stuff.

\begin{definition} 
Let $R \subset R'$ be an inclusion of integral domains.  An element $x \in R'$
is said to be \textbf{integral} over $R$ if $x$ satisfies a monic polynomial
equation in $R[X]$, say
\[ x^n + r_1 x^{n-1} + \dots + r_n = 0.  \]
\end{definition} 

\begin{example} 
$\frac{1+\sqrt{-3}}{2}$ is integral over $\mathbb{Z}$; it is in fact a sixth
root of unity.
\end{example} 

\begin{example} 
$\frac{1+\sqrt{5}}{2}$ is not integral over $\mathbb{Z}$. To explain this, we
need to work a bit more.
\end{example} 

We pause for a useful definition.
\begin{definition} 
An $R$-module $M$ is \textbf{finitely generated} if there exists a surjection
$R^n \to M$ for some $n$. In other words, it has a finite number of elements
whose ``span'' contains $M$.
\end{definition} 


Suppose $R \subset R'$ are domains.  Let $x \in R'$.  

\begin{proposition} 
$x \in R'$ is integral over $R$ if and only if the subalgebra $R[x]$
(generated by $R, x$) is a finitely generated
$R$-module.
\end{proposition} 

This for instance lets us show that $\frac{1+\sqrt{-5}}{2}$ is not integral
over $\mathbb{Z}$, because when you keep taking powers, you get arbitrarily
large denominators: the arbitrarily large denominators imply that it cannot be
integral.

\begin{proof} 
If $x  \in R'$ is integral, then $x$ satisfies
\[ x^n + r_1 x^{n-1}+\dots+r_n = 0.  \]
Then $R[x]$ is generated as an $R$-module by $1, x, \dots, x^{n-1}$.  This is
because the submodule generated by $1, x ,\dots, x^{n-1}$ is closed under
multiplication by $R$ and by multiplication by $x$ (by the above equation). 

Now suppose $x$ generates a subalgebra $R[x] \subset R'$ which is a finitely
generated $R$-module.  Then the increasing sequence
of $R$-modules generated by $\{1\}, \left\{1, x\right\}, \left\{1, x, x^2\right\}
, \dots$ must stabilize, since the union is $R[x]$.  It follows that some $x^n$
can be expressed as a linear combination of smaller powers of $x$. 
\end{proof} 

Last time we talked about integral extensions. If $R \subset R'$, we say that
an element $x \in R'$ is \textbf{integral} over $R$ if either of the following
equivalent conditions are satisfied:

\begin{enumerate}
\item There is a monic polynomial in $R[X]$ which vanishes on $x$.
\item $R[x] \subset R'$ is a finitely generated $R$-module.
\end{enumerate}

Last time we supposed that $R, R'$ were domains, but this is not really
necessary.

The first thing to do is to add a third equivalent condition.

\begin{proposition} 
$x \in R'$ is integral if and only if there exists a finitely generated
$R$-submodule $M \subset R'$ such that $R \subset M$ and $xM \subset M$.
\end{proposition} 
\begin{proof} 
It's obvious that the second condition above (equivalent to integrality) implies the condition of this
proposition. Indeed, you could just take $M = R[x]$.

Now let us prove that if there exists such an $M$ which is finitely generated,
then $x$ is integral. Just because $M$ is finitely generated, the
submodule $R[x]$ is not obviously finitely generated. In particular, this
implication  requires a bit of proof.


We shall prove that the condition of this proposition implies integrality.  
Suppose $y_1, \dots, y_k \in M$ generate $M$ as $R$-module. Then multiplication
by $x$ gives an $R$-module map $M \to M$. In particular, we can write
\[ xy_i = \sum a_{ij} y_j  \]
where each $a_{ij} \in R$.
These $\left\{a_{ij}\right\}$ may not be unique, but let us make some choices;
we get a $k$-by-$k$ matrix $A \in M_k(R)$. The claim is that $x$ satisfies the
characteristic polynomial of $A$.

Consider the matrix
\[ (x 1 - A) \in M_n(R').  \]
Note that $(x1-A)$ annihilates each $y_i$, by the choice of $A$.
We can consider the adjoint $B = (x1  -A)^{adj}$.  Then 
\[ B(x1 - A) = \det(x1 - A) 1.  \]
This product of matrices obviously annihilates each vector $y_i$.  It follows
that
\[ (\det(x1 - A) y_i = 0, \quad \forall i,  \]
which implies that $\det (x1-A)$ kills $M$. This implies that $\det (x1 - A)=0$ since $R \subset M$.

As a result, $x$ satisfies the chaacteristic polynomial.
\end{proof} 

We proved this to show that the set of integral elements is well behaved.

\begin{theorem} 
Let $R \subset R'$. Let $S = \left\{x \in R': x \text{ is integral over }
R\right\}$. Then $S$ is a subring of $R'$. In particular, it is closed under
addition and multiplication. 
\end{theorem} 
\begin{proof} 
Suppose $x,y \in S$.  
We can consider the finitely generated modules $R[x], R[y] \subset R'$
generated (as algebras) by $x$ over $R$. By assumption, these are finitely
generated $R$-modules. In particular, the tensor product
\[ R[x] \otimes_R R[y]  \]
is a finitely generated $R$-module. 
Indeed:
\begin{lemma} 
If $M, N$ are finitely generated, then $M \otimes_R N$ is finitely generated.  
\end{lemma} 
\begin{proof} 
Indeed, if we have surjections $R^m \to M, R^n \to N$, we can tensor them; we
get a surjection since the tensor product is right-exact.
So have a surjection
$R^{m n} = R^m \otimes_R R^n \to M \otimes_R N$. 
\end{proof} 

Back to the main proof. As stated, $R[x] \otimes_R R[y]$ is finitely generated
as an $R$-module. We have a ring-homomorphism $R[x]\otimes_R R[y] \to R'$
which comes from the inclusions $R[x], R[y] \rightarrowtail R'$.

Let $M$ be the image of $R[x] \otimes_R R[y]$ in $R'$. Then $M$ is an
$R$-submodule of $R'$, indeed an $R$-subalgebra containing $x,y$.  Also, $M$ is
finitely generated. Since $x+y, xy\in M$ and $M$ is a subalgebra, it follows that
\[ (x+y) M \subset M, \quad xy M \subset M.  \]
Thus $x+y, xy$ are integral over $R$.
\end{proof} 

\section{Integral closure}
\begin{definition} 
If $R \subset R'$, then the set $S = \left\{x \in R': x \ \mathrm{is \
integral  }\right\}$ is called the \textbf{integral closure} of $R$ in $R'$. We
say that $R$ is \textbf{integrally closed in $R'$} if $S = R'$. 


When $R$ is a domain, and $K$ is the quotient field $R_{(0)}$, we shall simply
say that $R$ is \textbf{integrally closed} if it is integrally closed in
$K$.
Alternatively, some people say that $R$ is \textbf{normal} in this case.
\end{definition} 

\begin{example} 
The integers $\mathbb{Z} \subset \mathbb{C}$ have as integral closure the set
of complex numbers $x$ satisfying a monic polynomial with integral
coefficients.  This set is called the set of \textbf{algebraic integers}.
\end{example} 

\begin{example} 
$i$ is an algebraic integer because it satisfies the equation $X^2 +1 = 0$.
$\frac{1 - \sqrt{-3}}{2}$ is an algebraic integer, as we talked about last
time; it is a sixth root of unity.  On the other hand, $\frac{1+\sqrt{-5}}{2}$
is not an algebraic integer. 
\end{example} 

\begin{example} 
Take $\mathbb{Z} \subset \mathbb{Q}$. The claim is that $\mathbb{Z}$ is
integrally closed in $\mathbb{Q}$, or simply---integrally closed. 
\end{example} 
\begin{proof} 
We will build on this proof on Friday. Here is the point. Suppose $\frac{a}{b}
\in \mathbb{Q}$ satisfying an equation
\[ p(a/b) = 0, \quad p(t) = t^n + c_1 t^{n-1} + \dots + c_0 , \ \forall c_i \in
\mathbb{Z}.\]
Assume that $a,b$ have no common factors; we must prove that $b$ has no prime
factors, so is $\pm 1$. 
If $b$ had a prime factor, say $q$, then we must obtain a contradiction.

We interrupt with a fancy definition.
\begin{definition} 
The \textbf{valuation at $q$} (or \textbf{$q$-adic valuation}) is the map
$v_q: \mathbb{Q}^* \to \mathbb{Z}$ is the
function sending $q^k (a/b)$ to $k$ if $q \nmid a,b$. We extend this to all
rational numbers via $v(0) = \infty$. 
\end{definition} 
In general, this just counts the number of factors of $q$ in the expression.


Note the general property that
\[ v_q(x+y) \geq \min( v_q(x), v_q(y)) . \]
If $x,y$ are both divisible by some power of $q$, so is $x+y$; this is the
statement above. We also have the useful property
\[ v_q(xy) = v_q(x) + v_q(y).  \]




Now return to the proof that $\mathbb{Z}$ is normal. We would like to show that
\[ v_q(a/b) \geq 0.  \]
This will prove that $b$ is not divisible by $q$.

We are assuming that $p(a/b) = 0$. In particular,
\[ \left( \frac{a}{b}  \right)^n = -c_1 \left( \frac{a}{b}  \right)^{n-1} -
\dots - c_0.  \]
Apply $v_q$ to both sides:
\[ n v_q ( a/b) \geq \min_i v_q( c_i (a/b)^{n-i}).  \]
Since the $c_i \in \mathbb{Z}$, their valuations are nonnegative. In
particular, the right hand side is at least
\[ \min_i  (n-i) v_q(a/b). \]
This cannot happen if $v_q(a/b)<0$, because $n-i < n$ for each $i$. 
\end{proof} 

This argument applies more generally. If $R \subset K$ is a subring ``defined
by valuations,'' then $R$ is integrally closed in $K$.  We will talk more about
this, and about valuation rings, next time.  
$\mathbb{Z}$ is defined by valuations in the sense that it consists of the
elements of $\mathbb{Q}$ which have all nonnegative valuations.

We will finish this lecture by discussing what it means to be integrally closed
geometrically.

\begin{example} 
Here is a ring which is not integrally closed. Take  $\mathbb{C}[x, y]/(x^2 - y^3)$.

In the complex plane, $\mathbb{C}^2$, this corresponds to the subvariety $C
\subset \mathbb{C}^2$ defined by $x^2 =
y^3$.  In $\mathbb{R}^2$, this can be drawn: it has a singularity at $(x,y)=0$.  

Note that $x^2 = y^3$ if and only if there is a complex number $z$ such that $x
= z^3, y = z^2$. This complex number $z$ can be recovered via $x/y$ when $x,y
\neq 0$. In particular, there is a map $\mathbb{C} \to C$ which sends $z \to
(z^3, z^2)$.  At every point other than the origin, the inverse can be
recovered using rational functions. But this does not work at the origin. 

We can think of $\mathbb{C}[x,y]/(x^2 - y^3)$ as the subring $R'$ of $\mathbb{C}[z]$
generated by $\left\{z^n, n \neq 1\right\}$.  There is a map from
$\mathbb{C}[x,y]/(x^2 - y^3)$ sending $x \to z^3, y \to z^2$.  Since these two
domains are isomorphic, and $R'$ is not integrally closed, it follows that
$\mathbb{C}[x,y]/(x^2 - y^3)$ is not integrally closed.
The element $z$ can be thought of as an element of the fraction field of $R'$
or of $\mathbb{C}[x,y]/(x^2 - y^3)$.  
It is integral, though. 

The failure of integrally closedness has to do with the singularity at the
origin.  
\end{example} 


We now give a generalization of the above example.

\begin{example}
This example is outside the scope of the present course.  Say that $X \subset
\mathbb{C}^n$ is given as the zero locus of some holomorphic functions
$\left\{f_i: \mathbb{C}^{n} \to \mathbb{C}\right\}$.  We just gave an example
when $n=2$.
Assume that $0 \in X$, i.e. each $f_i$ vanishes at the origin.  

Let $R$ be the ring of germs of holomorphic functions $0$, in other words
holomorphic functions from small open neighborhoods of zero.  Each of these
$f_i$ becomes an  element of $R$.  The ring
\[ R/(\left\{f_i\right\} ) \]
is called the ring of germs of holomorphic functions on $X$ at zero. 

Assume that $R$ is a domain.  This assumption, geometrically, means that near
the point zero in $X$, $X$ can't be broken into two smaller closed analytic
pieces.  The fraction field of $R$ is to be thought of as the ring of
germs of meromorphic functions on $X$ at zero.

We state the following without proof:

\begin{theorem} 
Let $g/g'$ be an element of the fraction field, i.e. $g, g' \in R$. Then $g/g'$
is integral over $R$ if and only if $g/g'$ is bounded near zero. 
\end{theorem} 

In the previous example of $X$ defined by $x^2 = y^3$, the function $x/y$
(defined near the origin on the curve) is
bounded near the origin, so it is integral over the ring of germs of regular
functions. The reason it is not defined near the origin is \emph{not} that it
blows up. In fact, it extends continuously, but not holomorphically, to the
rest of the variety $X$. 
\end{example} 





\section{Valuation rings}
Today, we will talk about the notion of a ``valuation ring.''

\begin{definition} 
A \textbf{valuation ring} is a domain $R$ such that for every pair of elements
$a,b \in R$, either $a \mid b$ or $b \mid a$. 
\end{definition} 

\begin{example} 
$\mathbb{Z}$ is not a valuation ring. Neither 2 divides 3 nor 3 divides 2.
\end{example} 

\begin{example} 
$\mathbb{Z}_{(p)}$, which is the set of all fractions of the form $a/b \in
\mathbb{Q}$ where $p \nmid b$, is a valuation ring. To check whether $a/b$
divides $a'/b'$ or vice versa, you  just have to check which is divisible by
the larger power of $p$. 
\end{example} 

\begin{remark} Let $R$ be a valuation ring.
Let $K$ be the fraction field of $R$. Then for all $x \in K^*$, either $x$ or
$x^{-1}$ belongs to $R$. Indeed, if $x=a/b , \ a,b \in R$, then either $a \mid
b$ or $b \mid a$, so either $x$ or $x^{-1} \in R$. This condition is equivalent
to $R$'s being a valuation ring.
\end{remark} 

Why are these called valuation rings? Well, 
\begin{definition} 
Let $K$ be a field. A \textbf{valuation} on $K$ is a map $v: K^* \to A$ for $A$
is a totally ordered abelian group  satisfying:
\begin{enumerate}
\item $v(xy) = v(x) + v(y)$. I.e., $v$ is a homomorphism. 
\item $v(x+y) \geq \min v(x), v(y)$. (We define $v(0) = \infty$ by convention;
this is a formal constant bigger than everything in $A$.)
\end{enumerate}

\end{definition} 
Suppose that $K$ is a field and $v: K \to A \cup \left\{\infty\right\}$ is a
valuation (i.e. $v(0) = \infty$). Define $R = \left\{x \in K: v(x) \geq
0\right\}$.
\begin{proposition} 
$R$ as just defined is a valuation ring. 
\end{proposition} 
\begin{proof}  First, we prove that $R$ is a ring.
$R$ is closed under addition and multiplication by the two conditions 
\[ v(xy)  = v(x) + v(y)  \]
and
\[ v(x+y) \geq \min v(x), v(y) , \]
so if $x,y \in R$, then $x+y, xy$ have nonnegative valuations. 

Note that $0 \in R$ because $v(0) = \infty$. Also $v(1) = 0$ since $v: K^* \to A$
is a homomorphism. So $1 \in R$ too. 
Finally, $-1 \in R$ because $v(-1) =0$ since $A$ is totally ordered.  It
follows that $R$ is also a group. 

Let us now show that $R$ is a valuation ring. If $x \in K^*$, either $v(x) \geq
0$ or $v(x^{-1}) \geq 0$ since $A$ is totally ordered.\footnote{Otherwise $0
=v(x)+v(x^{-1}) < 0$, contradiction.} So either $x, x^{-1} \in R$.
\end{proof} 

In particular, the set of elements with nonnegative valuation is a valuation
ring.
The converse also holds. Whenever you have a valuation ring, it comes about in
this manner.

\begin{proposition} 
Let $R$ be a valuation ring with quotient field $K$. There is an ordered
abelian group
$A$ and a valuation $v: K^* \to A$ such that $R$ is the set of elements with
nonnegative valuation.
\end{proposition} 
\begin{proof} 
First, we construct $A$. In fact, it is the quotient of $K^*$ by the subgroup
of units  $R^*$ of $R$.  
We define an ordering by saying that $x \leq y$ if $y/x \in R$---this doesn't
depend on the representatives in $K^*$ chosen.  Note that either $x \leq y$ or
$y \leq x$ must hold, since $R$ is a valuation ring. 
The combination of $ x \leq y$ and $y \leq x$ implies that $x,y$ are equivalent
classes.
The nonnegative elements in this group are those whose representatives in $K^*$
belong to $R$.

It is easy to see that $K^*/R^*$ in this way is a totally ordered abelian group with
the image of 1 as the unit. The
reduction map $K^* \to K^*/R^*$  defines a valuation whose corresponding ring
is just $R$. We have omitted some details; for instance, it should be checked
that the valuation of $x+y$ is at least the minimum of $v(x), v(y)$. 
\end{proof} 



To summarize:
\begin{quote}
Every valuation ring $R$ determines a valuation $v$ from the fraction field of
$R$ into $A \cup \left\{\infty\right\}$ for $A$ a totally ordered abelian group
such that $R$ is just the set of elements of $K$ with nonnegative valuation. As
long as we require that $v: K^* \to A$ is surjective, then $A$ is uniquely
determined as well.
\end{quote}

\begin{definition} 
A valuation ring $R$ is \textbf{discrete} if we can choose $A$ to be
$\mathbb{Z}$. 
\end{definition} 

\begin{example} 
$\mathbb{Z}_{(p)}$ is a discrete valuation ring.  
\end{example} 

The notion of a valuation ring is a useful one.

\subsection{General remarks}
Let $R$ be a commutative ring. Then $\spec R$ is the set of primes of $R$, equipped
with a certain topology. The space $\spec R$ is almost never Hausdorff. It is
almost always a bad idea to apply the familiar ideas from elementary topology
(e.g. the fundamental group) to $\spec R$. Nonetheless, it has some other nice
features that substitute for its non-Hausdorffness.

For instance, if $R = \mathbb{C}[x,y]$, then $\spec R$ corresponds to
$\mathbb{C}^2$ with some additional nonclosed points.  The injection of
$\mathbb{C}^2$ with its usual topology into $\spec R$ is continuous. While in
$\spec R$ you don't want to think of continuous paths, you can in
$\mathbb{C}^2$.

Suppose you had two points $x,y \in \mathbb{C}^2$ and their images in $\spec
R$.  Algebraically, you can still think about algebraic curves passing through $x,y$.
This is a subset of $x,y$ defined by a single polynomial equation. 
This curve will have what's called a ``generic point,'' since the ideal
generated by this curve will be a prime ideal.
The closure of this generic point will be precisely this algebraic
curve---including $x,y$. 

\begin{remark} 
If $ \mathfrak{p}, \mathfrak{p}' \in \spec R$, then 
\[ \mathfrak{p}' \in \overline{\left\{\mathfrak{p}\right\}}  \]
iff 
\[ \mathfrak{p}' \supset \mathfrak{p}.  \]
Why is this? Well, the closure of $\left\{\mathfrak{p}\right\}$ is just
$V(\mathfrak{p})$, since this is the smallest closed subset of $\spec R$
containing $\mathfrak{p}$.  
\end{remark} 

The point of this discussion is that instead of paths, one can transmit
information from point to point in $\spec R$ by having one point be in a
closure of another.
However, we will show that this relation is contained by the theory of
valuation rings.

\begin{theorem} 
Let $R$ be a domain containing a prime ideal $\mathfrak{p}$.  Let $K$ be the
fraction field of $R$.

Then there is a valuation  $v$ on $K$ defining a valuation ring $R' \subset
K$  such that
\begin{enumerate}
\item $R \subset R'$. 
\item $\mathfrak{p} = \left\{x \in R: v(x) > 0\right\}$.
\end{enumerate}

\end{theorem} 

Let us motivate this by the remark:
\begin{remark} 
A valuation ring is automatically a local ring. A local ring is a ring where
either $x, 1-x$ is invertible for all $x$ in the ring. Let us show that this is
true for a valuation ring. 

If $x $ belongs to a valuation ring $R$ with valuation $v$, it is invertible if
$v(x)=0$.  So if $x, 1-x$ were both noninvertible, then both would have
positive valuation.  However, that would imply that $v(1) \geq \min v(x),
v(1-x)$ is positive, contradiction.
\end{remark} 

\begin{quote}
If $R'$ is any valuation ring (say defined by a valuation $v$), then $R'$ is
local with maximal ideal consisting of elements with positive valuation. 
\end{quote}

The theorem above says that there's a good supply of valuation rings.
In particular, if $R$ is any domain, $\mathfrak{p} \subset R$ a prime ideal,
then we can choose a valuation ring $R' \supset R$ such that $\mathfrak{p}$ is
the intersection of the maximal ideal of $R'$ intersected with $R$.
So the map $\spec R' \to \spec R$ contains $\mathfrak{p}$.

\begin{proof} 
Without loss of generality, replace $R$ by $R_{\mathfrak{p}}$, which is a local
ring with maximal ideal $\mathfrak{p}R_{\mathfrak{p}}$. The maximal ideal
intersects $R$ only in $\mathfrak{p}$.

So, we can assume without loss of generality that 
\begin{enumerate}
\item $R$ is local. 
\item $\mathfrak{p}$ is maximal.
\end{enumerate}

Let $P$ be the collection of all subrings $R' \subset K$ such that $R' \supset
R$ but $\mathfrak{p}R' \neq R'$.  Then $P$ is a poset under inclusion. The
poset is nonempty, since $R \in P$.  Every totally ordered chain in $P$ has an
upper bound.  If you have a totally ordered subring of elements in $P$, then
you can take the union.  
We invoke:
\begin{lemma} 
Let $R_\alpha$ be a chain in $P$ and $R' = \bigcup R_\alpha$. Then $R' \in P$.
\end{lemma} 
\begin{proof} 
Indeed, it is easy to see that this is a subalgebra of $K$ containing $R$. The
thing to observe is that 
\[ \mathfrak{p}R' = \bigcup_\alpha \mathfrak{p} R_\alpha  ;\]
since by assumption, $1 \notin \mathfrak{p}R_\alpha$ (because each $R_\alpha
\in P$), $1 \notin \mathfrak{p}R'$. In particular, $R' \notin P$.
\end{proof} 

By the lemma, Zorn's lemma to the poset $P$. In particular, $P$ has a maximal
element $R'$. By construction, $R'$ is some subalgebra of $K$ and
$\mathfrak{p}R' \neq R'$. Also, $R'$ is maximal with respect to these
properties.

We show first that $R'$ is local, with maximal ideal $\mathfrak{m}$ satisfying
\[ \mathfrak{m} \cap R = \mathfrak{p}.  \]
The second part is evident from locality of $R'$, since $\mathfrak{m} $ must contain
the proper ideal $\mathfrak{p}R'$, and $\mathfrak{p} \subset R$ is a maximal
ideal. 

Suppose that $x \in R'$; we show that either $x, 1-x$ belongs to $R'^*$ (i.e.
is invertible). Take the ring $R'[x^{-1}]$.  If $x$ is noninvertible, this
properly contains $R'$.  By maximality, it follows that $\mathfrak{p}R'[x^{-1}]
= R'[x^{-1}]$. 

And we're out of time. We'll pick this up on Monday. 

\end{proof} 

\subsection{Valuation rings, continued}
Let us set a goal for today.


First, recall the notion introduced last time. A \textbf{valuation ring} is a
domain $R$ where for all $x$ in the fraction field of $R$, either $x$ or
$x^{-1}$ lies in $R$. We saw that if $R$ is a valuation ring, then $R$ is
local. That is, there is a unique maximal ideal $\mathfrak{m} \subset R$,
automatically prime.  Moreover, the zero ideal $(0)$ is prime, as $R$ is a
domain. So if you look at the spectrum $\spec R$ of a valuation ring $R$, there
is a unique closed point $\mathfrak{m}$, and a unique generic point
$(0)$.  There might be some other prime ideals in $\spec R$; this depends on
where the additional valuation lives.

\begin{example} 
Suppose the valuation defining the valuation ring $R$ takes values in
$\mathbb{R}$. Then the only primes are $\mathfrak{m}$ and zero.
\end{example} 

Let $R$ now be any ring, with $\spec R$ containing prime ideals
$\mathfrak{p} \subset \mathfrak{q}$.  In particular, $\mathfrak{q}$ lies in
the closure of $\mathfrak{p}$. 
As we will see, this implies that there is a map
\[  \phi: R \to R'  \]
such that $\mathfrak{p} = \phi^{-1}(0)$ and $\mathfrak{q} =
\phi^{-1}(\mathfrak{m})$, where $\mathfrak{m}$ is the maximal ideal of $R'$.
This statement says that the relation of closure in $\spec R$ is always
controlled by valuation rings.  
In yet another phrasing, in the map
\[ \spec R' \to \spec R  \]
the closed point goes to $\mathfrak{q}$ and the generic point to
$\mathfrak{p}$. This is our eventual goal.

To carry out this goal, we need some more elementary facts. Let us discuss
things that don't have any obvious relation to it.

\subsection{Some useful tools}

OK. Let us recall:

\begin{definition} 
A map of rings $\phi: R \to R'$ is \textbf{integral} if $\phi$ is injective and
each element $x \in R'$ is integral over $R$ (i.e. the image $\phi(R)$), or
satisfies a monic polynomial whose coefficients lie in the image of the
homomorphism $\phi$.
\end{definition} 

We now interpret integrality in terms of the geometry of $\spec$. 

\begin{proposition}[Lying over]
If $\phi: R \to R'$ is an integral extension, then the induced map
\[ \spec R' \to \spec R  \]
is surjective.
\end{proposition} 

Another way to state this, without mentioning $\spec R'$, is that if
$\mathfrak{p} \subset R$ is prime, then there exists $\mathfrak{q} \subset R'$
such that $\mathfrak{p}$ is the inverse image $\phi^{-1}(\mathfrak{q})$.

\begin{proof} 
First, let us reduce to the case of a local ring. 
We replace $R$ with $R_{\mathfrak{p}}$.  We get a map
\[ \phi_{\mathfrak{p}}: R_{\mathfrak{p}} \to (R- \mathfrak{p})^{-1} R'  \]
which is injective if $\phi$ is, since localization is an exact functor. Here we
have localized both $R, R'$ at the multiplicative subset $(R - \mathfrak{p})$.

Note that $\phi_{\mathfrak{p}}$ is an integral extension too, i.e. every $x/s$
with $x \in R', s \in R - \mathfrak{p}$ satisfies a monic polynomial with
coefficients in $R_{\mathfrak{p}}$. To see this, note that $x$ is integral over
$R$, so there is a monic polynomial
\[ x^n + a_1 x^{n-1} + \dots + a_0 = 0, \quad \forall a_i \in R \ (=\phi(R)).  \]
We can divide this by $s^n$:
\[ (\frac{x}{s})^n  + \frac{a_1}{s} (\frac{x}{s})^{n-1} + \dots +
\frac{a_0}{s^n} = 0,  \]
where each fraction in the coefficient is in the image of $\phi_{\mathfrak{p}}$.
That proves that $\phi_{\mathfrak{p}}$ is also integral.

We will prove the result for $\phi_{\mathfrak{p}}$.  In particular, we will show
that there is a prime ideal of $(R- \mathfrak{p})^{-1} R'$ that pulls back to
$\mathfrak{p}R_{\mathfrak{p}}$. These will imply that if we pull this prime
ideal back to $R'$, it will pull back to $\mathfrak{p}$ in $R$.
So it is sufficient for the proposition to handle the case of $R$ local.  

Upshot: we can assume $R$ is local with maximal ideal $\mathfrak{p}$. We assume
this now.
So, we want to find a prime ideal $\mathfrak{q} \subset R'$ such that
$\mathfrak{p}  = \phi^{-1}(\mathfrak{q})$. Since $\mathfrak{p}$ is already
maximal, it will suffice to show that $\mathfrak{p} \subset
\phi^{-1}(\mathfrak{q})$. In particular, we need to show that there is a prime
ideal $\mathfrak{q}$ such that
\[ \mathfrak{p} R' \subset \mathfrak{q}.  \]
The pull-back of this will be $\mathfrak{p}$. 

If $\mathfrak{p}R' \neq R'$, then
$\mathfrak{q}$ exists, since every proper ideal of a ring is contained in a
maximal ideal. In particular, we need to show that
\[ \mathfrak{p} R' \neq R', \]
or that $\mathfrak{p}$ doesn't generate the unit ideal in $R'$. Suppose the
contrary. Then $1 \in \mathfrak{p}R'$ and we can write
\[ 1 = \sum x_i \phi(y_i)  \]
where $x_i \in R', y_i \in \mathfrak{p}$. 

Let $R''$ be the subalgebra of $R'$ generated by $\phi(R)$ and the $x_i$. Then
$R'' \subset R'$ and is finitely generated over $R$, because it is generated by
the $x_i$. However, $R''$ is actually finitely generated as an $R$-module too,
because each $x_i$ satisfies a monic polynomial with coefficients in $R$. This
is where integrality comes in.

So we have that $R''$ is a finitely generated $R$-module. Also, the expression
$1 = \sum x_i \phi(y_i)$ shows that $\mathfrak{p}R'' = R''$. However, this
contradicts Nakayama's lemma. That brings the contradiction, showing that
$\mathfrak{p}$ cannot generate $(1)$ in $R'$, proving the lying over theorem. 

\end{proof} 

\subsection{Back to the goal} Now we return to the goal of the  lecture. Again, $R$
was any ring, and we had primes $\mathfrak{p} \subset \mathfrak{q} \subset R$. We
wanted a valuation ring $R'$ and a map $\phi: R \to R'$ such that zero pulled
back to $\mathfrak{p}$ and the maximal ideal pulled back to $\mathfrak{q}$.

What does it mean for $\mathfrak{p}$ to be the inverse image of $(0) \subset
R'$? This means that $\mathfrak{p} = \ker \phi$. So we get an injection 
\[ R/\mathfrak{p} \rightarrowtail R'.  \]
We will let $R'$ be a subring of the quotient field $K$ of the domain
$R/\mathfrak{p}$. Of course, this subring will contain $R/\mathfrak{p}$. 

In this case, we will get  a map $R \to R'$ such that the pull-back of zero is
$\mathfrak{p}$.  What we want, further, to be true is that $R'$ is a valuation
ring and the pull-back of the maximal ideal is $\mathfrak{q}$. 



This is starting to look at the problem we discussed last time.
Namely, let's throw out $R$, and replace it with  $R/\mathfrak{p}$.  
Moreover, we can replace $R$ with $R_{\mathfrak{q}}$ and assume that $R$ is
local with maximal ideal $\mathfrak{q}$.
What we need to show is that a valuation ring $R' $ contained in the fraction
field of $R$, containing $R$, such that the intersection of the maximal ideal of
$R'$ with $R$ is equal to $\mathfrak{q} \subset R$.
If we do this, then we will have accomplished our goal.  

\begin{lemma}
Let $R$ be a local domain. Then there is a valuation subring $R'$ of the quotient
field of $R$ that \emph{dominates} $R$, i.e .the map $R \to R'$ is a
\emph{local} homomorphism.
\end{lemma}

Let's find $R'$ now.

Choose $R'$ maximal such that $\mathfrak{q} R' \neq R'$. Such a ring exists, by
Zorn's lemma. We gave this argument at the end last time.

\begin{lemma} 
$R'$ as described is local.
\end{lemma} 
\begin{proof} 
Look at $\mathfrak{q}R' \subset R'$; it is a proper subset, too, by assumption.
In particular, $\mathfrak{q}R'$ is contained in some maximal ideal
$\mathfrak{m}\subset R'$.   Replace $R'$ by $R'' = R'_{\mathfrak{m}}$.  Note that
\[ R' \subset R''  \]
and
\[ \mathfrak{q}R'' \neq R''  \]
because $\mathfrak{m}R'' \neq R''$.  But $R'$ is maximal, so $R' = R''$, and
$R''$ is a local ring. So $R'$ is a local ring. 
\end{proof} 

Let $\mathfrak{m}$ be the maximal ideal of $R'$. Then $\mathfrak{m} \supset
\mathfrak{q}R$, so $\mathfrak{m} \cap R = \mathfrak{q}$. 
All that is left to prove now is that $R'$ is a valuation ring.  

\begin{lemma} 
$R'$ is integrally closed.
\end{lemma} 

\begin{proof} 
Let $R''$ be its integral closure. Then $\mathfrak{m} R'' \neq R''$ by lying
over, since $\mathfrak{m}$ (the maximal ideal of $R'$) lifts up to $R''$. So
$R''$ satisfies
\[ \mathfrak{q}R'' \neq R''  \]
and by maximality, we have $R'' = R'$. 
\end{proof} 

To summarize, we know that $R'$ is a  local, integrally closed subring of the
quotient field of $R$, such that the maximal ideal of $R'$ pulls back to
$\mathfrak{q}$ in $R$.
All we now need is:

\begin{lemma} 
$R'$ is a valuation ring.
\end{lemma} 
\begin{proof} 
Let $x$ lie in the fraction field. We must show that either $x$ or $x^{-1} \in
R'$.  Say $x \notin R'$.  This means by maximality of $R'$ that $R'' = R'[x]$ satisfies
\[ \mathfrak{q}R'' = R''.  \]
In particular, we can write
\[ 1 = \sum q_i x^i, \quad q_i \in \mathfrak{q}R' \subset R'.  \]
This implies that
\[ (1-q_0) + \sum_{i > 0} -q_i x^i  = 0.  \]
But $1-q_0$ is invertible in $R'$, since $R'$ is local.  We can divide by the
highest power of $x$:
\[  x^{-N} + \sum_{i>0} \frac{-q_i}{1-q_0} x^{-N+i} = 0. \]
In particular, $1/x$ is integral over $R'$; this implies that $1/x \in R'$ since
$R'$ is integrally closed and $q_0$ is a nonunit. So
$R'$ is a valuation ring. 
\end{proof} 

We can state the result formally.
\begin{theorem} 
Let $R$ be a ring, $\mathfrak{p} \subset \mathfrak{q}$ prime ideals. Then there
is a homomorphism $\phi: R \to R'$ into a valuation ring $R'$ with maximal ideal
$\mathfrak{m}$ such that
\[ \phi^{-1}(0) = \mathfrak{p}  \]
and
\[ \phi^{-1}(\mathfrak{m} ) = \mathfrak{q} .\]
\end{theorem} 

There is a related fact which we now state.
\begin{theorem} 
Let $R$ be any domain. Then the integral closure of $R$ in the quotient field
$K$ is the intersection 
\[ \bigcap R_{\alpha}  \]
of all valuation rings $R_{\alpha} \subset K$ containing $R$.
\end{theorem} 
So an element of the quotient field is integral over $R$ if and only if its
valuation is nonnegative at every valuation which is nonnegative on $R$.

\begin{proof} 
The $\subset$ argument is easy, because one can check that a valuation ring is
integrally closed. (Exercise.)
The interesting direction is to assume that $v(x) \geq 0$ for all $v$ nonnegative
on $R$. 

Let us suppose $x$ is nonintegral. Suppose $R' = R[1/x]$ and $I$ be the ideal
$(x^{-1}) \subset R'$. There are two cases:
\begin{enumerate}
\item $I = R'$. Then in the ring $R'$, $x^{-1} $ is invertible. In particular,
$x^{-1}P(x^{-1}) = 1$. Multiplying by a high power of $x$ shows that $x$ is
integral over $R$.  Contradiction.
\item  Suppose $I \subsetneq R'$. Then $I$ is contained in a maximal ideal
$\mathfrak{q} \subset R'$.  There is a valuation subring $R'' \subset K$ ,
containing $R'$, such that the corresponding valuation is positive on
$\mathfrak{q}$.  In particular, this valuation is positive on $x^{-1}$, so it is
negative on $x$, contradiction. 
\end{enumerate}
\end{proof} 

So the integral closure has this nice characterization via valuation rings. In
some sense, the proof that $\mathbb{Z}$ is integrally closed has the property
that every integrally closed ring is integrally closed for that reason: it's the
common nonnegative locus for some valuations.  

