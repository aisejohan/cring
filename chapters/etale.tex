\chapter{\'Etale, unramified, and smooth morphisms}


In this chapter, we shall introduce three classes of morphisms of rings
defined by lifting properties and study their properties.

\section{Formally unramified maps}
\label{section-formally-unramified}


\subsection{Definition}
It turns out to be logically more efficient to define
the notion of a formally unramified map before introducing
the notion of a formally \'etale one.

\begin{definition}
\label{definition-formally-unramified}
Let $R \to S$ be a ring map.
We say $S$ is {\bf formally unramified over $R$} if for every
commutative solid diagram
\begin{equation} \label{inflift}
\xymatrix{
S \ar[r] \ar@{-->}[rd] & A/I \\
R \ar[r] \ar[u] & A \ar[u]
}
\end{equation}
where $I \subset A$ is an ideal of square zero, there exists
at most one dotted arrow making the diagram commute.
\end{definition}

In other words, an $R$-algebra $S$ is formally unramified if and only if
whenever $A$ is an $R$-algebra and $I \subset A$ an ideal of square zero, the
map of sets
\[ \hom_R(S, A) \to \hom_R(S, A/I)  \]
is injective.


\begin{proposition} 
The following are equivalent for a $R$-algebra $S$:
\begin{enumerate}
\item  $\Omega_{S/R}=0$.
\item $S$ is formally unramified over $R$.
\end{enumerate}
\end{proposition} 
\begin{proof} 
Suppose first $\Omega_{S/R}=0$. This is equivalent to the statement that
\emph{any} $R$-derivation of $S$ into an $S$-module is trivial.
If given an $R$-algebra $T$ with an ideal $I \subset T$ of square zero and a
morphism 
\[ S \to T/I,  \]
and two liftings $f,g: S \to T$, then we find that $f-g$ maps $S$ into $I$.
Since $T/I$ is naturally an $S$-algebra, it is easy to see (since $I$ has
square zero) that $I$ is naturally an $S$-module and $f-g$ is an
$R$-derivation $S \to I$. 
Thus $f-g \equiv 0$ and $f=g$.

Conversely, suppose $S$ has the property that liftings in \eqref{inflift} are
unique.
Consider the $S$-module $T=S \oplus \Omega_{S/R}$ with the multiplicative
structure $(a,a')(b,b') = (ab, ab' + a'b)$ that makes it into an algebra.
(This is a general construction one can do with an $S$-module $M$: $S \oplus
M$ is an algebra where $M$ becomes an ideal of square zero.)

Consider the ideal $\Omega_{S/R} \subset T$, which has
square zero; the quotient is $S$. We will find two liftings of the identity $S
\to S$. For the first, define $S \to T$ sending $s \to (s,0)$. For the second,
define $S \to T$ sending $s \to (s, ds)$; the derivation property of $b$ shows
that this is a morphism of algebras.

By the lifting property, the two morphisms $S \to T$ are equal. In particular,
the map $S \to \Omega_{S/R}$ sending $s \to ds$ is trivial. This implies that
$\Omega_{S/R}=0$.

\end{proof} 

%most of the code below was contributed by the Stacks project authors
\begin{lemma}
\label{lemma-formally-unramified-local}
Let $R \to S$ be a ring map.
The following are equivalent:
\begin{enumerate}
\item $R \to S$ is formally unramified,
\item $R \to S_{\mathfrak q}$ is formally unramified for all
primes $\mathfrak q$ of $S$, and
\item $R_{\mathfrak p} \to S_{\mathfrak q}$ is formally unramified
for all primes $\mathfrak q$ of $S$ with $\mathfrak p = R \cap \mathfrak q$.
\end{enumerate}
\end{lemma}

\begin{proof}
We have seen in
\rref{lemma-characterize-formally-unramified}
that (1) is equivalent to
$\Omega_{S/R} = 0$. Similarly, by
\rref{lemma-differentials-localize}
we see that (2) and (3)
are equivalent to $(\Omega_{S/R})_{\mathfrak q} = 0$ for all
$\mathfrak q$. Hence the equivalence follows from
\rref{lemma-characterize-zero-local}.
\end{proof}

We shall now give the typical list of properties (``le sorite'') of unramified morphisms.

\begin{proposition} \label{locunramified}
Any map $R \to R_f$ for $f \in  R$ is unramified.
\end{proposition} 
More generally, a map from a ring to any localization is \emph{formally}
unramified, but not necessarily unramified. 
\begin{proof} 
Indeed, we know that $\Omega_{R/R}  = 0$ and $\Omega_{R_f/R } =
(\Omega_{R/R})_f=0$, and the amp is clearly of finite type.
\end{proof} 

\begin{proposition} 
A surjection of rings is unramified.
\end{proposition} 
\begin{proof} 
Obvious.
\end{proof} 

In the language of schemes, one can define the notion of an \emph{unramified
morphism,} and it then follows that any immersion is unramified.

\begin{proposition} 
If $R \to S$ and $S \to T$ are unramified, so is $R \to T$.
\end{proposition} 
\begin{proof} 
It is clear that $R \to T$ is of finite type. We need to check that
$\Omega_{T/R}  = 0$. However, we have a standard exact sequence (cf.
\cite{Ei95})
\[ \Omega_{S/R}\otimes_S T \to \Omega_{T/R} \to \Omega_{T/S} \to 0,  \]
and since $\Omega_{S/R} = 0, \Omega_{T/S} = 0$, we find that $\Omega_{T/R}  =
0$.
\end{proof} 


\begin{proposition}  \label{unrbasechange}
If $R \to S$ is unramified, so is $R' \to S' = S \otimes_R R'$ for any $R$-algebra
$R'$.
\end{proposition} 
\begin{proof} 
This follows from the fact that $\Omega_{S'/R'} = \Omega_{S/R} \otimes_S S'$.
Alternatively, it can be checked easily using the lifting criterion.
\end{proof} 


In fact, the question of what unramified morphisms look like can be reduced to
the case where the ground ring is a \emph{field} in view of the previous and
the following result.

Given $\mathfrak{p} \in \spec R$, we let $k(\mathfrak{p})$ to be the residue
field of $R_{\mathfrak{p}}$.


\begin{corollary} \label{reduceunrtofield} 
Let $\phi: R \to S$ be a morphism of finite type. Then $\phi$ is unramified if
and only if for every $\mathfrak{p} \in \spec R$, we have
\[ k(\mathfrak{p}) \to S \otimes_R k(\mathfrak{p})  \]
unramified.
\end{corollary} 
\begin{proof} 
One direction is clear by \cref{unrbasechange}. For the other, suppose
$k(\mathfrak{p}) \to S \otimes_R k(\mathfrak{p})$ unramified for all $\mathfrak{p} \subset R$.
We then know that 
\[ \Omega_{S/R} \otimes_R k(\mathfrak{p}) = \Omega_{S \otimes_R
k(\mathfrak{p})/k(\mathfrak{p})} = 0  \]
for all such $\mathfrak{p}$. By localization, it follows that
\begin{equation} \label{auxdiff} \mathfrak{p}
\Omega_{S_{\mathfrak{q}}/R_{\mathfrak{p}}} =
\Omega_{S_{\mathfrak{q}}/R_{\mathfrak{p}}} = \Omega_{S_{\mathfrak{q}}/R}  \end{equation}
for any $\mathfrak{q} \in \spec S$ lying over $\mathfrak{p}$.

Let $\mathfrak{q} \in \spec S$. We will now show that
$(\Omega_{S/R})_{\mathfrak{q}} = 0$. 
Given this, we will find that $\Omega_{S/R} =0$, which will prove the
assertion of the corollary. 


Indeed, let $\mathfrak{p} \in \spec R$ be
the image of $\mathfrak{q}$, so that there is a \emph{local} homomorphism 
$R_{\mathfrak{p}} \to S_{\mathfrak{q}}$. By \cref{auxdiff}, we find that
\[ \mathfrak{q} \Omega_{S_{\mathfrak{q}}/R} = \Omega_{S_{\mathfrak{q}}/R}.  \]
and since $\Omega_{S_{\mathfrak{q}}/R}$ is a finite $S_{\mathfrak{q}}$-module,
Nakayama's lemma now implies that $\Omega_{S_{\mathfrak{q}}/R}=0$, proving
what we wanted. 
\end{proof} 


\begin{lemma}
\label{lemma-formally-unramified-localize}
Let $A \to B$ be a formally unramified ring map.
\begin{enumerate}
\item For $S \subset A$ a multiplicative subset,
$S^{-1}A \to S^{-1}B$ is formally unramified.
\item For $S \subset B$ a multiplicative subset,
$A \to S^{-1}B$ is formally unramified.
\end{enumerate}
\end{lemma}

\begin{proof}
Follows from
\rref{lemma-formally-unramified-local}.
(You can also deduce it from
\rref{lemma-characterize-formally-unramified}
combined with
\rref{lemma-differentials-localize}.)
\end{proof}


\section{Formal smoothness}

\subsection{Introduction}
The idea of a \emph{smooth} morphism in algebraic geometry is one that is
surjective on the tangent space, at least if one is working with smooth
varieties over an algebraically closed field. So this means that one should be
able to lift tangent vectors, which are given by maps from the ring into
$k[\epsilon]/\epsilon^2$.

This makes the following definition seem more plausible:

\begin{definition} 
Let $B$ be an $A$-algebra. Then $B$ is \textbf{formally smooth} if given any
$A$-algebra $D$ and ideal $I \subset D $ of square zero, the map
\[ \hom_A(B, D) \to \hom_A(B, D/I)\]
is a surjection.
\end{definition} 

So this means that in any diagram
\[ \xymatrix{
B \ar@{-->}[r] \ar[rd] & D \ar[d]  \\
& D/J
}\]
there exists a dotted arrow making the diagram commute.

\begin{definition} 
If the above lifting problem has a \textbf{unique solution} for every pair $(D,
J)$, then $B$ is called \textbf{formally etale} as an $A$-algebra. If there is
at most one solution, then $B$ is called \textbf{formally unramified.}
\end{definition} 


It's not too hard to check that formally unramified is equivalent to
$\Omega_{B/A} = 0$. See for instance my notes on the subject. (Ultimately, we
are going to show that formal smoothness is equivalent to the cotangent complex
being homotopy equivalent to the homology in dimension zero (which is
$\Omega_{B/A}$) and the module $\Omega_{B/A}$ being projective.)


The basic example of a formally smooth $A$-algebra is the polynomial ring
$A[x_1, \dots, x_n]$. For to give a map $A[x_1, \dots, x_n] \to D/J$ is to give
$n$ elements of $D/J$; each of these elements can clearly be lifted to $D$.
This is analogous to the statement that a free module is projective.

Now, ultimately, we want to show that this somewhat abstract definition of
formal smoothness will give us something nice and geometric when $B$ is in
addition of finite presentation. In particular, in this case we want to show
that $B$ is \emph{flat.} 
To do this, we will need to do a bit of work, but we can argue in a fairly
elementary manner. On the one hand, we will need to give a criterion for when a
quotient of a formally smooth ring is formally smooth.

\subsection{Quotients of formally smooth rings}


\begin{theorem}[EGA 0-IV, 22.6.1]
Let $A$ be a ring, $B$ an $A$-algebra. Suppose $B$ is formally smooth over $A$,
and let $I \subset B$ be an ideal. 

Then $C = B/I$ is a formally smooth $A$-algebra if and only if the canonical map
\[ I/I^2 \to \Omega_{B/A} \otimes_B C  \]
has a section.
In other words, $C$ is formally smooth precisely when the conormal sequence
\[  I/I^2 \to \Omega_{B/A} \otimes_B C \to \Omega_{C/A} \to 0 \]
is split exact.
\end{theorem} 

EGA states this in more generality for \emph{topological} rings, and uses
some functors on ring extensions. 

\begin{proof} 
Suppose first $C$ is formally smooth over $A$.
Then we have a map
\[ B/I^2 \to C  \]
given by the quotient. 
There is a diagram of $A$-algebras
\[ \xymatrix{
B/I & \ar[l] B/I^2 \\
C \ar[u] \ar@{-->}[ru]
}\]
and the lifting $C \to B/I^2$ exists by formal smoothness. 
This is a section of the natural projection $B/I^2 \to C = B/I$, which is a
morphism of $A$-algebras.
In particular, we get a splitting 
\[ B/I^2 = B/I \oplus I/I^2  \]
from the exact sequence
\[ 0 \to I/I^2 \to B/I^2 \to C \to 0.  \]
Since the section of $B/I^2 \to C$ was a section of \emph{rings}, we see that
the splitting is a splitting of $A$-algebras, where $I/I^2$ squares to zero.

We are interested in showing that $I/I^2 \to \Omega_{B/A} \otimes_B C$ is a
split injection of $C$-modules. To see this, we will show that any map out of the former
extends to a map out of the latter.
Now suppose given a map
of $C$-modules
\[ \phi:  I/I^2 \to M \]
into a $C$-module $M$.
Then we get a derivation
\[ \delta:  B/I^2 \to M  \]
by using the splitting $B/I^2 = C \oplus I/I^2$.
(Namely, we just extend the map by zero on $C$.)
Since $I/I^2$ is imbedded in $B/I^2$ by the canonical injection, this
derivation restricts on $I/I^2$ to $\phi$. In other words there is a
commutative diagram
\[ \xymatrix{
I/I^2 \ar[d]^{\phi}  \ar[r] &  B/I^2 \ar[ld]^{\delta} \\
M
}.\]
It follows thus that we may define, by pulling back, an $A$-derivation $B \to
M$ that restricts on $I$ to the map $I \to I/I^2 \stackrel{\phi}{\to} M$. 
By the universal property of the differentials, this is the same thing as a
homomorphism $\Omega_{B/A} \to M$, or equivalently $\Omega_{B/A} \otimes_B C
\to M$ since $M$ is a $C$-module.

It follows that the map
\[ \hom_C(\Omega_{B/A} \otimes_B C, M) \to \hom_C(I/I^2, M)  \]
is a surjection. This proves one half of the result.

Now for the other.
Suppose that there is a section.
This translates, as above, to saying that
any map $I/I^2 \to M$  (of $C$-modules) for a $C$-module $M$
 can be extended to an $A$-derivation $B \to M$.

Now let $E$ be any $A$-algebra, and $J \subset E$
an ideal of square zero.
We suppose given an $A$-homomorphism $C \to E/J$
and would like to lift it to $C \to E$; in other words, we must 
find a lift in the diagram
\[ \xymatrix{
& C \ar@{-->}[ld] \ar[d]  \\
E \ar[r] & E/J
}.\]
Let us pull this map back by the surjection 
$B \twoheadrightarrow C$; we get a diagram
\[ \xymatrix{
& B \ar@{-->}[ldd] \ar[d] \\
& C \ar@{-->}[ld] \ar[d]  \\
E \ar[r] & E/J
}.\]
In this diagram, we know that a lifting $\phi: B \to E$ does exist because $B$ is
formally smooth over $A$.
So we can find a dotted arrow from $B \to E$ in the diagram.
The problem is that it might not send
$I = \ker(C \to B) $ into zero.
If it does, then we're golden.

In any event, we have a morphism of $A$-modules
$  I \to E$  given by restricting $\phi: B \to E$.
This lands in $J$, so we get a map $I \to J$. Note that $J$ is an $E/J$-module,
hence a $C$-module, because $J$ has square zero. Moreover $I^2$ gets sent to
zero because $J^2 = 0$, and we have a morphism of
$C$-modules $I/I^2 \to J$.
Now by hypothesis, there is an $A$-derivation
$\delta: B \to J$ such that $\delta|_I = \phi$.
Since $J$ has square zero, it follows that
\[ \phi - \delta: B \to E  \]
is an $A$-homomorphism of algebras, and it kills $I$.
Consequently this factors through $C$ and gives the desired lifting $C \to E$.



\end{proof} 

\begin{corollary} 
If $A \to B$ is formally smooth, then 
$\Omega_{B/A}$ is a projective $B$-module.
\end{corollary} 
\begin{proof} 
Indeed, we can write $B$ as a quotient of a polynomial ring $D$ over $A$; this
is formally smooth. Suppose $B = D/I$.
Then we know that there is a split exact sequence
\[ 0 \to I/I^2 \to \Omega_{D/A} \otimes_D B \to \Omega_{B/A} \to 0.  \]
But the middle term is free as $D/A$ is a polynomial ring; hence the last term
is projective.
\end{proof} 
\subsection{The Jacobian criterion}


So now we want  a characterization of when a morphism is smooth. Let us
motivate this with an analogy from standard differential topology. 
Consider real-valued functions $f_1, \dots, f_p \in C^{\infty}(\mathbb{R}^n)$.
Now, if $f_1, f_2, \dots, f_p$ are such that their gradients $\nabla f_i$ form a
matrix of rank $p$, then we can define a manifold near zero
which is the common zero set of all the $f_i$.
We are going to give a relative version of this in the algebraic setting.



Recall that a map of rings $A \to B$ is \emph{essentially of finite
presentation} if $B$ is the localization of a finitely presented $A$-algebra.


\begin{proposition} 
Let $(A, \mathfrak{m}) \to (B, \mathfrak{n})$ be a local homomorphism of local
rings such that $B$ is essentially of finite presentation.
Suppose $B = (A[X_1, \dots, X_n])_{\mathfrak{q}}/I$ for some finitely generated
ideal $I \subset A[X_1, \dots, X_n]_{\mathfrak{q}}$, where $\mathfrak{q}$ is a
prime ideal in the polynomial ring.

Then $I/I^2$ is generated as a $B$-module by polynomials
$f_1, \dots, f_k \in A[X_1, \dots, X_n]$ whose Jacobian matrix has maximal rank
in $B/\mathfrak{n}$ if and only if $B$ is formally smooth over $A$.
In this case, $I/I^2$ is even freely generated by the $f_i$.
\end{proposition} 
\begin{proof} 
Indeed, we know that polynomial rings are formally smooth. 
In particular $D = A[X_1, \dots, X_n]_{\mathfrak{q}}$ is formally smooth over
$A$, because localization preserves formal smoothness. (This is
straightforward.) Note also that $\Omega_{D/A}$ is a free $D$-module, because
this is true for a polynomial ring and K\"ahler differentials commute with
localization.

So the previous result implies that
\[ I/I^2 \to \Omega_{D/A} \otimes_D B  \]
is a split injection precisely when $B$ is formally smooth over $A$. Suppose
that this holds.
Now $I/I^2$ is then a summand of the free module $\Omega_{D/A} \otimes_D B$, so it
is projective, hence free as $B$ is local.
Let $K = B/\mathfrak{n}$. It follows that the map
\[ I/I^2 \otimes K \to \Omega_{D/A} \otimes_D  K = K^n \]
is an injection. This map sends $f \mapsto df$. Hence the assertion is clear.

Conversely, suppose that $I/I^2$ has such generators. 
Then the map 
\[ I/I^2 \otimes K \to K^n, \quad f\mapsto df  \]
is a split injection. 
However, if a map of finitely generated modules over a local ring, with the
target free, is such that tensoring with
the residue field makes it an injection, then it is a split injection. (We
shall prove this below.) Thus $I/I^2 \to \Omega_{D/A} \otimes_D B$ is a split
injection. In view
of the criterion for formal smoothness, we find that $B$ is formally smooth.
\end{proof} 

\subsection{A minor lemma on modules over local rings}

\begin{lemma} 
If $(A, \mathfrak{m})$ is a local ring with residue field $k$, $M$ a finitely
generated $A$-module, $N$ a finitely
generated projective $A$-module, then a map
\[ \phi: M \to N  \]
is a split injection if and only if
\[ M \otimes k \to N \otimes k  \]
is an injection.
\end{lemma} 
\begin{proof} 
One direction is clear, so it suffices to show that $M \to N$ is a split
injection if the map on fibers is an injection.


Let $L$ be a ``free approximation'' to $M$, that is, a free module $L$ together
with a map $L \to M$ which is an isomorphism modulo $k$. By Nakayama's lemma,
$L \to M$ is surjective.
Then the map
$L \to M \to N$ is such that the $L \otimes k \to N \otimes k$ is injective, so
$L \to N$ is a split injection (by an elementary criterion).
It follows that we can find a splitting $N \to L$, which when composed with $L
\to M$ is a splitting of $M \to N$.
\end{proof}
\section{Formal smoothness implies flatness}

\begin{lemma} 
Let $(A, \mathfrak{m}) \to (B, \mathfrak{n})$ be a local homomorphism of local
rings.
Let $M$ be a finitely generated $B$-module, which is flat over $A$. 

Let $f \in B$. Then the following are equivalent:
\begin{enumerate}
\item $M/fM$ is flat over $A$ and $f: M \to M$ is injective.
\item $f: M \otimes k \to M \otimes k$ is injective where $k = A/\mathfrak{m}$.
\end{enumerate}
\end{lemma} 

This is  a useful criterion of checking when an element is $M$-regular by
checking on the fiber.
\begin{proof} All $\tor$ functors here will be over $A$. 
If $M/fM$ is $A$-flat and $f: M \to M$ is injective, then the sequence
\[ 0 \to M \stackrel{f}{\to} M \to M/fM \to 0 \]
leads to a long exact sequence
\[ \tor_1(k, M/fM) \to M \otimes k \stackrel{f}{\to} M \otimes k \to (M/fM)
\otimes k \to 0. \]
But since $M/fM$ is flat, it follows that $M \otimes k \stackrel{f}{\to} M
\otimes k$ is injective.

The other direction is more subtle. Suppose multiplication by $f$ is a
monomorphism on $M \otimes k$. Now write the exact sequence
\[ 0 \to P \to M \stackrel{f}{\to} M \to Q \to 0 \]
where $P, Q$ are the kernel and cokernel. 
We can also consider the image $I = fM \subset M$, to split this into two
exact sequences
\[ 0 \to P \to M \to I \to 0  \]
and 
\[ 0 \to I \to M \to Q \to 0.  \]
Here the map $M \otimes k \to I \otimes k \to M \otimes k$ is given by
multiplication by $f$, so it is injective by hypothesis. This implies that $M \otimes k \to I
\otimes k$ is injective. So $M \otimes k \to I \otimes k$ is actually an isomorphism because it
is obviously surjective, and we have just seen it is injective.
Next, since $M \to I$ is surjective, $I \otimes k \to M
\otimes k$ is also injective.

(Given a sequence $X \to Y \to Z$ such that $A
\to Y$ is surjective, $X \to Z$ is injective, it follows that $B \to C$ is
itself injective: for if a nonzero $b \in Y$ mapped to zero in $Z$, then $b$ is hit by
something in $X$, nonzero. Then that would go to zero in $Z$, contradiction.)

Let us tensor these two exact sequences with $k$. We get
\[ 0 \to  \tor_1(k, I) \to P \otimes k \to M  \otimes k \to I \otimes k \to 0   \]
because $M$ is flat. We also get
\[ 0 \to  \tor_1(k, Q) \to I \otimes k \to M  \otimes k \to Q \otimes k \to 0
.\]
We'll start by using the second sequence. Now $I \otimes k \to M \otimes k$
was just said to be injective, so that $\tor_1(k, Q) = 0$. By the local
criterion for flatness, it follows that $Q$ is a flat 
$A$-module as well. 
But $Q = M/fM$, so this gives one part of what we wanted.

Now, we want to show finally that $P = 0$. 
Now, $I$ is flat; indeed, it is the kernel of a surjection of flat maps $M \to
Q$, so the long exact sequence shows that it is flat. So we have a short exact
sequence
\[ 0 \to P \otimes k \to M \otimes k \to I \otimes k \to 0,  \]
which shows now that $P \otimes k  = 0$ (as $M \otimes k \to I \otimes k$ was
just shown to be injective earlier). By Nakayama $P = 0$.
This implies that $f$ is $M$-regular.
\end{proof}

\begin{corollary} Let $(A, \mathfrak{m}) \to (B, \mathfrak{n})$ be a morphism
of noetherian local rings.
Suppose $M$ is a finitely generated $B$-module, which is flat over $A$.

Let $f_1, \dots, f_k \in \mathfrak{n}$. Suppose that $f_1, \dots, f_k$ is a
regular sequence on $M \otimes k$. Then it is a regular sequence on $M$ and,
in fact, $M/(f_1, \dots, f_k ) M$ is flat over $A$.
\end{corollary} 
\begin{proof} 
This is now clear by induction. 
\end{proof} 

\subsection{The main result}
\begin{theorem}[EGA IV 17.5.1] Let $(A, \mathfrak{m}) \to (B, \mathfrak{n})$ be
a morphism of local noetherian rings such that $B$ is the localization of a f.p. $A$-algebra at a prime
ideal, $B = (A[X_1, \dots, X_n])_{\mathfrak{q}}/I$. Then if $A \to B$ is formally smooth, $B$ is a flat $A$-algebra.
\end{theorem} 
\begin{proof} 
Let $C = (A[X_1, \dots, X_n])_{\mathfrak{q}}$. Then $C$ is a local ring,
essentially of finite type over $A$, and we have morphisms of local rings
\[ (A, \mathfrak{m}) \to (C, \mathfrak{q}) \twoheadrightarrow (B,
\mathfrak{n}).  \]
Moroever, $C$ is a \emph{flat} $A$-module, and we are going to apply the
fiberwise criterion for regularity to $C$.

Now we know that $I/I^2$ is a $B$-module generated by polynomials $f_1, \dots, f_n
\in A[X_1, \dots, X_n]$
whose Jacobian matrix has maximal rank in $B/\mathfrak{n}$.
The claim is that the $f_i$ are linearly independent in
$\mathfrak{q}/\mathfrak{q}^2$. This will be the first key step in the proof.
In other words, if $\left\{u_i\right\}$ is a family of elements of $C$, not all
non-units, we do not have
\[ \sum u_i f_i \in \mathfrak{q}^2.  \]
For if we did, then we could take derivatives
and find
\[ \sum u_i \partial_j f_i \in \mathfrak{q}  \]
for each $j$. This contradicts the gradients of the $f_i$ being linearly
independent in $B/\mathfrak{n} = C/\mathfrak{q}$. 

Now we want to show that the $\left\{f_i\right\}$ form a regular sequence in
$C$. To do this, we shall reduce to the case where $A$ is a field. Indeed, let
us make the base-change $A \to k, B \to \overline{B} = B \otimes k, C \to \overline{C}=C \otimes k$ where $k  =
A/\mathfrak{m}$ is the residue field.
Then $\overline{B},\overline{C}$ are  formally smooth local rings over a
field $k$. We also know that $\overline{C}$ is a \emph{regular} local ring,
since it is a localization of a polynomial ring over a field. 


Let us denote the maximal ideal of
$\overline{C}$ by
$\overline{\mathfrak{q}}$; this is just the image of $\mathfrak{q}$.


Now the $\left\{f_i\right\}$ have images in $\overline{C}$ that are linearly
independent
in $\overline{\mathfrak{q}}/\overline{\mathfrak{q}}^2 =
\mathfrak{q}/\mathfrak{q}^2$. It follows that the $\left\{f_i\right\}$ form a
regular sequence in $\overline{C}$, by general facts about regular local
rings; indeed, each of the successive quotients $\overline{C}/(f_1, \dots,
f_k)$ will then be regular.
It follows from the fiberwise criterion ($C$ being flat) that the
$\left\{f_i\right\}$ form a regular sequence in $C$ itself, and that the
quotient $C/(f_i) = B$ is $A$-flat.
\end{proof} 

In fact, we can get a general criterion now:

\begin{theorem} 
Let $(A, \mathfrak{m}) \to (B, \mathfrak{n})$ be a morphism of local
noetherian rings such that $B$ is the localization of a f.p. $A$-algebra at a prime
ideal, $B = (A[X_1, \dots, X_n])_{\mathfrak{q}}/I$. Then $B$ is formally
smooth over $A$ if $B$ is $A$-flat and $B/\mathfrak{m}B$ is formally smooth
over $A/\mathfrak{m}$.
\end{theorem} 

\begin{proof} 
One direction is immediate from what we have already shown. Now we need to
show that if $B$ is $A$-flat, and $B/\mathfrak{m}B$ is formally smooth over
$A/\mathfrak{m}$, then $B$ is itself formally smooth over $A$.

As before, write the sequence
\[ (A, \mathfrak{m}) \to (C, \mathfrak{q}) \twoheadrightarrow (B,\mathfrak{n})
\]
where $C$ is a localization of a polynomial ring at a prime ideal, and in
particular is formally smooth over $A$. 
We know that $B = C/I$, where $I \subset \mathfrak{q}$.

To check that $B$ is formally smooth over $A$, we need to show ($C$ being
formally smooth) that the conormal sequence
\[ I/I^2 \to  \Omega_{C/A} / I \Omega_{C/A} \to \Omega_{C/B} \to 0. \]
is split exact. 

Let $\overline{A}, \overline{C}, \overline{B}$ be the base changes of $A, B,
C$ to $k = A/\mathfrak{m}$; let $\overline{I}$ be the kernel of $\overline{C}
\twoheadrightarrow \overline{B}$.
Note that $\overline{I} = I/\mathfrak{m}I$ by flatness of $B$.
Then we know that the sequence
\[ \overline{I}/\overline{I}^2 \to  \Omega_{\overline{C}/k} / \overline{I}
\Omega_{\overline{C}/k} \to \Omega_{\overline{C}/\overline{B}} \to 0\]
is split exact, because $\overline{C}$ is a formally smooth $k$-algebra.

In particular, there are polynomials $\overline{P}_1, \dots, \overline{P}_r
\in \overline{C}$ (which is the localization of a polynomial ring over $k$)
which generate $\overline{I}/\overline{I}^2$ and
whose gradients are linearly independent in
$\overline{C}/\mathfrak{\overline{q}}$. These lift to polynomials in $I$
which generate (by Nakayama) $I/I^2$ and whose gradients are linearly
independent in the residue field $C/\mathfrak{q} =
\overline{C}/\overline{\mathfrak{q}}$.
Now by the Jacobian criterion, we are done.
\end{proof} 

\subsection{Formal smoothness and regularity}

We now want to explore the connection between formal smoothness and regularity.
In general, the intuition is that a variety over an algebraically closed field
is \emph{smooth} if and only if the local rings at closed points (and thus at
all points by \cref{locofregularloc}) are regular local rings. 
Over a non-algebraically closed field, only one direction is still true: we
want the local rings to be \emph{geometrically regular.}
So far we will just prove one direction, though.

\begin{theorem} 
Let $(A, \mathfrak{m})$ be a noetherian local ring containing a copy of its
residue field $A/\mathfrak{m}= k$. Then if $A$ is formally smooth over $k$, $A$
is regular.
\end{theorem} 
\begin{proof} 
We are going to compare the quotients $A/\mathfrak{m}^n$ to the quotients of
$R= k[x_1, \dots, x_n]$ where  $n$ is the \emph{embedding dimension} of
$A$.
Let $\mathfrak{n} \subset k[x_1, \dots, x_n]$ be the ideal $(x_1, \dots, x_n)$. 
We are going to give surjections
\[ A/\mathfrak{m}^k \twoheadrightarrow R/\mathfrak{n}^k  \]
for each $k \geq 2$.

Let $t_1, \dots, t_n \in \mathfrak{m}$ be a $k$-basis for
$\mathfrak{m}/\mathfrak{m}^2$.
Consider the map $A \twoheadrightarrow R/\mathfrak{n}^2 $ that goes
$A  \twoheadrightarrow A/\mathfrak{m}^2 \simeq  k \oplus
\mathfrak{m}/\mathfrak{m}^2 \simeq R/\mathfrak{n}^2$, where $t_i$ is sent to
$x_i$. This is well-defined, and gives a surjection $A \twoheadrightarrow
R/\mathfrak{n}^2$.
Using the infinitesimal lifting property, we can lift this map to maps
\[ A \to R/\mathfrak{n}^k  \]
for each $k$, which necessarily factor through $A/\mathfrak{m}^k$ (as they send
$\mathfrak{m}$ into $\mathfrak{n}$). They are surjective by Nakayama's lemma.
It follows that
\[ \dim_k R/\mathfrak{m}^k \geq \dim_k R/\mathfrak{n}^k,  \]
and since $R_{\mathfrak{n}}$ is a regular local ring, the last term grows
asymptotically like $k^n$. It follows that $\dim R \geq n$, and since $\dim R$
is always at most the embedding dimension, we are done.
\end{proof} 

\section{Conormal modules and universal thickenings}
\label{section-conormal}

\noindent
It turns out that one can define the first infinitesimal neighbourhood
not just for a closed immersion of schemes, but already for any formally
unramified morphism. This is based on the following algebraic fact.

\begin{lemma}
\label{lemma-universal-thickening}
Let $R \to S$ be a formally unramified ring map. There exists a surjection of
$R$-algebras $S' \to S$ whose kernel is an ideal of square zero with the
following universal property: Given any commutative diagram
$$
\xymatrix{
S \ar[r]_{a} & A/I \\
R \ar[r]^b \ar[u] & A \ar[u]
}
$$
where $I \subset A$ is an ideal of square zero, there is a unique $R$-algebra
map $a' : S' \to A$ such that $S' \to A \to A/I$ is equal to $S' \to S \to A$.
\end{lemma}

\begin{proof}
Choose a set of generators $z_i \in S$, $i \in I$ for $S$ as an $R$-algebra.
Let $P = R[\{x_i\_{i \in I}]$ denote the polynomial ring on generators
$x_i$, $i \in I$. Consider the $R$-algebra map $P \to S$ which maps
$x_i$ to $z_i$. Let $J = \text{Ker}(P \to S)$. Consider the map
$$
\text{d} : J/J^2 \longrightarrow \Omega_{P/R} \otimes_P S
$$
see
\rref{lemma-differential-seq}.
This is surjective since $\Omega_{S/R} = 0$ by assumption, see
\rref{lemma-characterize-formally-unramified}.
Note that $\Omega_{P/R}$ is free on $\text{d}x_i$, and hence the module
$\Omega_{P/R} \otimes_P S$ is free over $S$. Thus we may choose a splitting
of the surjection above and write
$$
J/J^2 = K \oplus \Omega_{P/R} \otimes_P S
$$
Let $J^2 \subset J' \subset J$ be the ideal of $P$ such that
$J'/J^2$ is the second summand in the decomposition above.
Set $S' = P/J'$. We obtain a short exact sequence
$$
0 \to J/J' \to S' \to S \to 0
$$
and we see that $J/J' \cong K$ is a square zero ideal in $S'$. Hence
$$
\xymatrix{
S \ar[r]_1 & S \\
R \ar[r] \ar[u] & S' \ar[u]
}
$$
is a diagram as above. In fact we claim that this is an initial object in
the category of diagrams. Namely, let $(I \subset A, a, b)$ be an arbitrary
diagram. We may choose an $R$-algebra map $\beta : P \to A$ such that
$$
\xymatrix{
S \ar[r]_1 & S \ar[r]_a & A/I \\
R \ar[r] \ar@/_/[rr]_b \ar[u] & P \ar[u] \ar[r]^\beta & A \ar[u]
}
$$
is commutative. Now it may not be the case that $\beta(J') = 0$, in other
words it may not be true that $\beta$ factors through $S' = P/J'$.
But what is clear is that $\beta(J') \subset I$ and
since $\beta(J) \subset I$ and $I^2 = 0$ we have $\beta(J^2) = 0$.
Thus the ``obstruction'' to finding a morphism from
$(J/J' \subset S', 1, R \to S')$ to $(I \subset A, a, b)$ is
the corresponding $S$-linear map $\overline{\beta} : J'/J^2 \to I$.
The choice in picking $\beta$ lies in the choice of $\beta(x_i)$.
A different choice of $\beta$, say $\beta'$, is gotten by taking
$\beta'(x_i) = \beta(x_i) + \delta_i$ with $\delta_i \in I$.
In this case, for $g \in J'$, we obtain
$$
\beta'(g) =
\beta(g) + \sum\nolimits_i \delta_i \frac{\partial g}{\partial x_i}.
$$
Since the map $\text{d}|_{J'/J^2} : J'/J^2 \to \Omega_{P/R} \otimes_P S$
given by $g \mapsto \frac{\partial g}{\partial x_i}\text{d}x_i$
is an isomorphism by construction, we see that there is a unique choice
of $\delta_i \in I$ such that $\beta'(g) = 0$ for all $g \in J'$.
(Namely, $\delta_i$ is $-\overline{\beta}(g)$ where $g \in J'/J^2$
is the unique element with $\frac{\partial g}{\partial x_j} = 1$ if
$i = j$ and $0$ else.) The uniqueness of the solution implies the
uniqueness required in the lemma.
\end{proof}

\noindent
In the situation of
\rref{lemma-universal-thickening}
the $R$-algebra map $S' \to S$ is unique up to unique isomorphism.

\begin{definition}
\label{definition-universal-thickening}
Let $R \to S$ be a formally unramified ring map.
\begin{enumerate}
\item The {\it universal first order thickening} of $S$ over $R$ is
the surjection of $R$-algebras $S' \to S$ of
\rref{lemma-universal-thickening}.
\item The {\it conormal module} of $R \to S$ is the kernel $I$ of the
universal first order thickening $S' \to S$, seen as a $S$-module.
\end{enumerate}
We often denote the conormal module {\it $C_{S/R}$} in this situation.
\end{definition}

\begin{lemma}
\label{lemma-universal-thickening-quotient}
Let $I \subset R$ be an ideal of a ring.
The universal first order thickening of $R/I$ over $R$
is the surjection $R/I^2 \to R/I$. The conormal module
of $R/I$ over $R$ is $C_{(R/I)/R} = I/I^2$.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-universal-thickening-localize}
Let $A \to B$ be a formally unramified ring map.
Let $\varphi : B' \to B$ be the universal first order thickening of
$B$ over $A$.
\begin{enumerate}
\item Let $S \subset A$ be a multiplicative subset.
Then $S^{-1}B' \to S^{-1}B$ is the universal first order thickening of
$S^{-1}B$ over $S^{-1}A$. In particular $S^{-1}C_{B/A} = C_{S^{-1}B/S^{-1}A}$.
\item Let $S \subset B$ be a multiplicative subset.
Then $S' = \varphi^{-1}(S)$ is a multiplicative subset in $B'$
and $(S')^{-1}B' \to S^{-1}B$ is the universal first order thickening
of $S^{-1}B$ over $A$. In particular $S^{-1}C_{B/A} = C_{S^{-1}B/A}$.
\end{enumerate}
Note that the lemma makes sense by
\rref{lemma-formally-unramified-localize}.
\end{lemma}

\begin{proof}
With notation and assumptions as in (1). Let $(S^{-1}B)' \to S^{-1}B$
be the universal first order thickening of $S^{-1}B$ over $S^{-1}A$.
Note that $S^{-1}B' \to S^{-1}B$ is a surjection of $S^{-1}A$-algebras
whose kernel has square zero. Hence by definition we obtain a map
$(S^{-1}B)' \to S^{-1}B'$ compatible with the maps towards $S^{-1}B$.
Consider any commutative diagram
$$
\xymatrix{
B \ar[r] & S^{-1}B \ar[r] & D/I \\
A \ar[r] \ar[u] & S^{-1}A \ar[r] \ar[u] & D \ar[u]
}
$$
where $I \subset D$ is an ideal of square zero. Since $B'$ is the universal
first order thickening of $B$ over $A$ we obtain an $A$-algebra map
$B' \to D$. But it is clear that the image of $S$ in $D$ is mapped to
invertible elements of $D$, and hence we obtain a compatible map
$S^{-1}B' \to D$. Applying this to $D = (S^{-1}B)'$ we see that we get
a map $S^{-1}B' \to (S^{-1}B)'$. We omit the verification that this map
is inverse to the map described above.

\medskip\noindent
With notation and assumptions as in (2). Let $(S^{-1}B)' \to S^{-1}B$
be the universal first order thickening of $S^{-1}B$ over $A$.
Note that $(S')^{-1}B' \to S^{-1}B$ is a surjection of $A$-algebras
whose kernel has square zero. Hence by definition we obtain a map
$(S^{-1}B)' \to (S')^{-1}B'$ compatible with the maps towards $S^{-1}B$.
Consider any commutative diagram
$$
\xymatrix{
B \ar[r] & S^{-1}B \ar[r] & D/I \\
A \ar[r] \ar[u] & A \ar[r] \ar[u] & D \ar[u]
}
$$
where $I \subset D$ is an ideal of square zero. Since $B'$ is the universal
first order thickening of $B$ over $A$ we obtain an $A$-algebra map
$B' \to D$. But it is clear that the image of $S'$ in $D$ is mapped to
invertible elements of $D$, and hence we obtain a compatible map
$(S')^{-1}B' \to D$. Applying this to $D = (S^{-1}B)'$ we see that we get
a map $(S')^{-1}B' \to (S^{-1}B)'$. We omit the verification that this map
is inverse to the map described above.
\end{proof}

\begin{lemma}
\label{lemma-differentials-universal-thickening}
Let $R \to A  \to B$ be ring maps. Assume $A \to B$ formally unramified.
Let $B' \to B$ be the universal first order thickening of $B$ over $A$.
Then $B'$ is formally unramified over $A$, and the canonical map
$\Omega_{A/R} \otimes_A B \to \Omega_{B'/R} \otimes_{B'} B$ is an
isomorphism.
\end{lemma}

\begin{proof}
We are going to use the construction of $B'$ from the proof of
\rref{lemma-universal-thickening}
allthough in principle it should be possible to deduce these results
formally from the definition. Namely, we choose a presentation
$B = P/J$, where $P = A[x_i]$ is a polynomial ring over $A$.
Next, we choose elements $f_i \in J$ such that
$\text{d}f_i = \text{d}x_i \otimes 1$ in $\Omega_{P/A} \otimes_P B$.
Having made these choices we have
$B' = P/J'$ with $J' = (f_i) + J^2$, see proof of
\rref{lemma-universal-thickening}.

\medskip\noindent
Consider the canonical exact sequence
$$
J'/(J')^2 \to \Omega_{P/A} \otimes_P B' \to \Omega_{B'/A} \to 0
$$
see
\rref{lemma-differential-seq}.
By construction the classes of the $f_i \in J'$ map to elements of
the module $\Omega_{P/A} \otimes_P B'$ which generate it modulo
$J'/J^2$ by construction. Since $J'/J^2$ is a nilpotent ideal, we see
that these elements generate the module alltogether (by
Nakayama's \rref{lemma-NAK}). This proves that $\Omega_{B'/A} = 0$
and hence that $B'$ is formally unramified over $A$, see
\rref{lemma-characterize-formally-unramified}.

\medskip\noindent
Since $P$ is a polynomial ring over $A$ we have
$\Omega_{P/R} = \Omega_{A/R} \otimes_A P \oplus \bigoplus P\text{d}x_i$.
We are going to use this decomposition.
Consider the following exact sequence
$$
J'/(J')^2 \to
\Omega_{P/R} \otimes_P B' \to
\Omega_{B'/R} \to 0
$$
see
\rref{lemma-differential-seq}.
We may tensor this with $B$ and obtain the exact sequence
$$
J'/(J')^2 \otimes_{B'} B \to
\Omega_{P/R} \otimes_P B \to
\Omega_{B'/R} \otimes_{B'} B \to 0
$$
If we remember that $J' = (f_i) + J^2$
then we see that the first arrow annihilates the submodule $J^2/(J')^2$.
In terms of the direct sum decomposition
$\Omega_{P/R} \otimes_P B =
\Omega_{A/R} \otimes_A B \oplus \bigoplus B\text{d}x_i $ given
we see that the submodule $(f_i)/(J')^2 \otimes_{B'} B$ maps
isomorphically onto the summand $\bigoplus B\text{d}x_i$. Hence what is
left of this exact sequence is an isomorphism
$\Omega_{A/R} \otimes_A B \to \Omega_{B'/R} \otimes_{B'} B$
as desired.
\end{proof}









\section{Formally \'etale maps}
\label{section-formally-etale}

\begin{definition}
\label{definition-formally-etale}
Let $R \to S$ be a ring map.
We say $S$ is {\it formally \'etale over $R$} if for every
commutative solid diagram
$$
\xymatrix{
S \ar[r] \ar@{-->}[rd] & A/I \\
R \ar[r] \ar[u] & A \ar[u]
}
$$
where $I \subset A$ is an ideal of square zero, there exists
a unique dotted arrow making the diagram commute.
\end{definition}

\noindent
Clearly a ring map is formally \'etale if and only if
it is booth formally smooth and formally unramified.

\begin{lemma}
\label{lemma-formally-etale-etale}
Let $R \to S$ be a ring map of finite presentation.
The following are equivalent:
\begin{enumerate}
\item $R \to S$ is formally \'etale,
\item $R \to S$ is \'etale.
\end{enumerate}
\end{lemma}

\begin{proof}
Assume that $R \to S$ is formally \'etale.
Then $R \to S$ is smooth by \rref{lemma-formally-smooth-smooth}.
By \rref{lemma-characterize-formally-unramified}
we have $\Omega_{S/R} = 0$.
Hence $R \to S$ is \'etale by definition.

\medskip\noindent
Assume that $R \to S$ is \'etale.
Then $R \to S$ is formally smooth by
\rref{lemma-smooth-formally-smooth}.
By \rref{lemma-characterize-formally-unramified}
it is formally unramified. Hence $R \to S$ is formally \'etale.
\end{proof}

\begin{lemma}
\label{lemma-colimit-formally-etale}
Let $R$ be a ring. Let $I$ be a directed partially ordered set.
Let $(S_i, \varphi_{ii'})$ be a system of $R$-algebras
over $I$. If each $R \to S_i$ is formally \'etale, then
$S = \text{colim}_{i \in I}\ S_i$ is formally \'etale over $R$
\end{lemma}

\begin{proof}
Consider a diagram as in \rref{definition-formally-etale}.
By assumption we get unique $R$-algebra maps $S_i \to A$ lifting
the compositions $S_i \to S \to A/I$. Hence these are compatible
with the transition maps $\varphi_{ii'}$ and define a lift
$S \to A$. This proves existence.
The uniqueness is clear by restricting to each $S_i$.
\end{proof}

\begin{lemma}
\label{lemma-localization-formally-etale}
Let $R$ be a ring. Let $S \subset R$ be any multiplicative subset.
Then the ring map $R \to S^{-1}R$ is formally \'etale.
\end{lemma}

\begin{proof}
Let $I \subset A$ be an ideal of square zero. What we are saying
here is that given a ring map $\varphi : R \to A$ such that
$\varphi(f) \mod I$ is invertible for all $f \in S$ we have also that
$\varphi(f)$ is invertible in $A$ for all $f \in S$. This is true because
$A^*$ is the inverse image of $(A/I)^*$ under the canonical map
$A \to A/I$.
\end{proof}





\section{Unramified ring maps}
\label{section-unramified}

\noindent
The definition of a G-unramified ring map is the one from EGA.
The definition of an unramified ring map is the one from \cite{Henselian}.

\begin{definition}
\label{definition-unramified}
Let $R \to S$ be a ring map.
\begin{enumerate}
\item We say $R \to S$ is {\it unramified} if $R \to S$ is of
finite type and $\Omega_{S/R} = 0$.
\item We say $R \to S$ is {\it G-unramified} if $R \to S$ is of finite
presentation and $\Omega_{S/R} = 0$.
\item Given a prime $\mathfrak q$ of $S$ we say that $S$ is
{\it unramified at $\mathfrak q$} if there exists a
$g \in S$, $g \not \in \mathfrak q$ such that $R \to S_g$ is unramified.
\item Given a prime $\mathfrak q$ of $S$ we say that $S$ is
{\it G-unramified at $\mathfrak q$} if there exists a
$g \in S$, $g \not \in \mathfrak q$ such that $R \to S_g$ is G-unramified.
\end{enumerate}
\end{definition}

\noindent
Of course a G-unramified map is unramified.

\begin{lemma}
\label{lemma-formally-unramified-unramified}
Let $R \to S$ be a ring map. The following are equivalent
\begin{enumerate}
\item $R \to S$ is formally unramified and of finite type, and
\item $R \to S$ is unramified.
\end{enumerate}
Moreover, also the following are equivalent
\begin{enumerate}
\item $R \to S$ is formally unramified and of finite presentation, and
\item $R \to S$ is G-unramified.
\end{enumerate}
\end{lemma}

\begin{proof}
Follows from \rref{lemma-characterize-formally-unramified}
and the definitions.
\end{proof}

\begin{lemma}
\label{lemma-unramified}
Properties of unramified and G-unramified ring maps.
\begin{enumerate}
\item The base change of an unramified ring map is unramified.
The base change of a G-unramified ring map is G-unramified.
\item The composition of unramified ring maps is unramified.
The composition of G-unramified ring maps is G-unramified.
\item Any principal localization $R \to R_f$ is G-unramified and
unramified.
\item If $I \subset R$ is an ideal, then $R \to R/I$ is unramified.
If $I \subset R$ is a finitely generated ideal, then $R \to R/I$ is
G-unramified.
\item An \'etale ring map is G-unramified and unramified.
\item If $R \to S$ is of finite type (resp.\ finite presentation),
$\mathfrak q \subset S$ is a prime and $(\Omega_{S/R})_{\mathfrak q} = 0$,
then $R \to S$ is unramified (resp.\ G-unramified) at $\mathfrak q$.
\item If $R \to S$ is of finite type (resp.\ finite presentation),
$\mathfrak q \subset S$ is a prime and
$\Omega_{S/R} \otimes_S \kappa(\mathfrak q) = 0$, then
$R \to S$ is unramified (resp.\ G-unramified) at $\mathfrak q$.
\item If $R \to S$ is of finite type (resp.\ finite presentation),
$\mathfrak q \subset S$ is a prime lying over $\mathfrak p \subset R$ and
$(\Omega_{S \otimes_R \kappa(\mathfrak p)/\kappa(\mathfrak p)})_{\mathfrak q}
= 0$, then $R \to S$ is unramified (resp.\ G-unramified) at $\mathfrak q$.
\item If $R \to S$ is of finite type (resp.\ presentation),
$\mathfrak q \subset S$ is a prime lying over $\mathfrak p \subset R$ and
$(\Omega_{S \otimes_R \kappa(\mathfrak p)/\kappa(\mathfrak p)})
\otimes_{S \otimes_R \kappa(\mathfrak p)} \kappa(\mathfrak q) = 0$,
then $R \to S$ is unramified (resp.\ G-unramified) at $\mathfrak q$.
\item If $R \to S$ is a ring map, $g_1, \ldots, g_m \in S$ generate
the unit ideal and $R \to S_{g_j}$ is unramified (resp.\ G-unramified) for
$j = 1, \ldots, m$, then $R \to S$ is unramified (resp.\ G-unramified).
\item If $R \to S$ is a ring map which is unramified (resp.\ G-unramified)
at every prime of $S$, then $R \to S$ is unramified (resp.\ G-unramified).
\item If $R \to S$ is G-unramified, then there exists a finite type
$\mathbf{Z}$-algebra $R_0$ and a G-unramified ring map $R_0 \to S_0$
and a ring map $R_0 \to R$ such that $S = R \otimes_{R_0} S_0$.
\item If $R \to S$ is unramified, then there exists a finite type
$\mathbf{Z}$-algebra $R_0$ and an unramified ring map $R_0 \to S_0$
and a ring map $R_0 \to R$ such that $S$ is a quotient of
$R \otimes_{R_0} S_0$.
\end{enumerate}
\end{lemma}

\begin{proof}
We prove each point, in order.

\medskip\noindent
Ad (1). Follows from Lemmas \rref{lemma-differentials-base-change}
and \rref{lemma-base-change-finiteness}.

\medskip\noindent
Ad (2). Follows from Lemmas \rref{lemma-exact-sequence-differentials}
and \rref{lemma-base-change-finiteness}.

\medskip\noindent
Ad (3). Follows by direct computation of $\Omega_{R_f/R}$ which we omit.

\medskip\noindent
Ad (4). We have $\Omega_{(R/I)/R} = 0$, see
\rref{lemma-trivial-differential-surjective},
and the ring map $R \to R/I$
is of finite type. If $I$ is a finitely generated ideal then $R \to R/I$
is of finite presentation.

\medskip\noindent
Ad (5). See discussion following \rref{definition-etale}.

\medskip\noindent
Ad (6). In this case $\Omega_{S/R}$ is a finite $S$-module (see
\rref{lemma-differentials-finitely-generated}) and hence there
exists a $g \in S$, $g \not \in \mathfrak q$ such that
$(\Omega_{S/R})_g = 0$. By \rref{lemma-differentials-localize}
this means that $\Omega_{S_g/R} = 0$ and hence $R \to S_g$ is
unramified as desired.

\medskip\noindent
Ad (7). Use Nakayama's lemma (\rref{lemma-NAK}) to see that
the condition is equivalent to the condition of (6).

\medskip\noindent
Ad (8) \& (9). These are equivalent in the same manner that (6) and (7)
are equivalent. Moreover
$\Omega_{S \otimes_R \kappa(\mathfrak p)/\kappa(\mathfrak p)} =
\Omega_{S/R} \otimes_S (S \otimes_R \kappa(\mathfrak p))$ by
\rref{lemma-differentials-base-change}.
Hence we see that (9) is equivalent to (7) since
the $\kappa(\mathfrak q)$ vector spaces in both are canonically
isomorphic.

\medskip\noindent
Ad (10). Follows from from Lemmas \rref{lemma-cover}
and \rref{lemma-differentials-localize}.

\medskip\noindent
Ad (11). Follows from (6) and (7) and the fact that the spectrum of $S$
is quasi-compact.

\medskip\noindent
Ad (12). Write $S = R[x_1, \ldots, x_n]/(g_1, \ldots, g_m)$.
As $\Omega_{S/R} = 0$ we can write
$$
\text{d}x_i = \sum h_{ij}\text{d}g_j + \sum a_{ijk}g_j\text{d}x_k
$$
in $\Omega_{R[x_1, \ldots, x_n]/R}$
for some $h_{ij}, a_{ijk} \in R[x_1, \ldots, x_n]$.
Choose a finitely generated
$\mathbf{Z}$-subalgebra $R_0 \subset R$ containing all the coefficients of the
polynomials $g_i, h_{ij}, a_{ijk}$. Set
$S_0 = R_0[x_1, \ldots, x_n]/(g_1, \ldots, g_m)$. This works.

\medskip\noindent
Ad (13). Write $S = R[x_1, \ldots, x_n]/I$.
As $\Omega_{S/R} = 0$ we can write
$$
\text{d}x_i = \sum h_{ij}\text{d}g_{ij} + \sum g'_{ik}\text{d}x_k
$$
in $\Omega_{R[x_1, \ldots, x_n]/R}$
for some $h_{ij} \in R[x_1, \ldots, x_n]$ and $g_{ij}, g'_{ik} \in I$.
Choose a finitely generated $\mathbf{Z}$-subalgebra $R_0 \subset R$
containing all the coefficients of the
polynomials $g_{ij}, h_{ij}, g'_{ik}$. Set
$S_0 = R_0[x_1, \ldots, x_n]/(g_{ij}, g'_{ik})$. This works.
\end{proof}

\begin{lemma}
\label{lemma-diagonal-unramified}
Let $R \to S$ be a ring map.
If $R \to S$ is unramified, then there exists an idempotent
$e \in S \otimes_R S$ such that $S \otimes_R S \to S$ is isomorphic
to $S \otimes_R S \to (S \otimes_R S)_e$.
\end{lemma}

\begin{proof}
Let $J = \text{Ker}(S \otimes_R S \to S)$. By assumption
$J/J^2 = 0$, see
\rref{lemma-differentials-diagonal}.
Since $S$ is of finite type over $R$ we
see that $J$ is finitely generated, namely by
$x_i \otimes 1 - 1 \otimes x_i$, where $x_i$ generate $S$ over $R$.
We win by \rref{lemma-ideal-is-squared-union-connected}.
\end{proof}

\begin{lemma}
\label{lemma-unramified-at-prime}
Let $R \to S$ be a ring map.
Let $\mathfrak q \subset S$ be
a prime lying over $\mathfrak p$ in $R$.
If $S/R$ is unramified at $\mathfrak q$ then
\begin{enumerate}
\item we have $\mathfrak p S_{\mathfrak q} = \mathfrak qS_{\mathfrak q}$
is the maximal ideal of the local ring $S_{\mathfrak q}$, and
\item the field extension $\kappa(\mathfrak p) \subset \kappa(\mathfrak q)$
is finite separable.
\end{enumerate}
\end{lemma}

\begin{proof}
We may first replace $S$ by $S_g$ for some $g \in S$, $g \not \in \mathfrak q$
and assume that $R \to S$ is unramified.
The base change $S \otimes_R \kappa(\mathfrak p)$
is unramified over $\kappa(\mathfrak p)$ by
\rref{lemma-unramified}.
By
\rref{lemma-characterize-smooth-over-field}
it is smooth hence \'etale over $\kappa(\mathfrak p)$.
Hence we see that
$S \otimes_R \kappa(\mathfrak p) =
(R \setminus \mathfrak p)^{-1} S/\mathfrak pS$
is a product of finite separable field extensions of
$\kappa(\mathfrak p)$ by \rref{lemma-etale-over-field}.
This implies the lemma.
\end{proof}

\begin{lemma}
\label{lemma-unramified-quasi-finite}
Let $R \to S$ be a finite type ring map.
Let $\mathfrak q$ be a prime of $S$.
If $R \to S$ is unramified at $\mathfrak q$ then
$R \to S$ is quasi-finite at $\mathfrak q$.
In particular, an unramified ring map is quasi-finite.
\end{lemma}

\begin{proof}
An unramified ring map is of finite type.
Thus it is clear that the second statement follows from the first.
To see the first statement apply the characterization of
\rref{lemma-isolated-point-fibre} part (2) using
\rref{lemma-unramified-at-prime}.
\end{proof}

\begin{lemma}
\label{lemma-characterize-unramified}
Let $R \to S$ be a ring map. Let $\mathfrak q$ be a prime of $S$
lying over a prime $\mathfrak p$ of $R$. If
\begin{enumerate}
\item $R \to S$ is of finite type,
\item $\mathfrak p S_{\mathfrak q}$ is the maximal ideal
of the local ring $S_{\mathfrak q}$, and
\item the field extension $\kappa(\mathfrak p) \subset \kappa(\mathfrak q)$
is finite separable,
\end{enumerate}
then $R \to S$ is unramified at $\mathfrak q$.
\end{lemma}

\begin{proof}
By \rref{lemma-unramified} (8) it suffices to show that
$\Omega_{S \otimes_R \kappa(\mathfrak p) / \kappa(\mathfrak p)}$
is zero when localized at $\mathfrak q$. Hence we may replace $S$
by $S \otimes_R \kappa(\mathfrak p)$ and $R$ by $\kappa(\mathfrak p)$.
In other words, we may assume that $R = k$ is a field and $S$
is a finite type $k$-algebra.
In this case the hypotheses imply that
$S_{\mathfrak q} \cong \kappa(\mathfrak q)$
and hence $S = \kappa(\mathfrak q) \times S'$ (see
\rref{lemma-isolated-point}).
Hence $(\Omega_{S/k})_{\mathfrak q} = \Omega_{\kappa(\mathfrak q)/k}$
which is zero as desired.
\end{proof}

\begin{proposition}
\label{proposition-unramified-locally-standard}
Let $R \to S$ be a ring map. Let $\mathfrak q \subset S$ be a prime.
If $R \to S$ is unramified at $\mathfrak q$, then there exist
\begin{enumerate}
\item a $g \in S$, $g \not \in \mathfrak q$,
\item a standard \'etale ring map $R \to S'$, and
\item a surjective $R$-algebra map $S' \to S_g$.
\end{enumerate}
\end{proposition}

\begin{proof}
This proof is the ``same'' as the proof of
\rref{proposition-etale-locally-standard}.
The proof is a little roundabout and there may be ways to
shorten it.

\medskip\noindent
Step 1. By \rref{definition-unramified}
there exists a $g \in S$, $g \not \in \mathfrak q$
such that $R \to S_g$ is unramified. Thus we may assume that $S$ is
unramified over $R$.

\medskip\noindent
Step 2. By \rref{lemma-unramified}
there exists an unramified ring map $R_0 \to S_0$
with $R_0$ of finite type over $\mathbf{Z}$, and a ring map
$R_0 \to R$ such that $S$ is a quotient of $R \otimes_{R_0} S_0$. Denote
$\mathfrak q_0$ the prime of $S_0$ corresponding to $\mathfrak q$.
If we show the result for $(R_0 \to S_0, \mathfrak q_0)$ then the
result follows for $(R \to S, \mathfrak q)$ by base change. Hence
we may assume that $R$ is Noetherian.

\medskip\noindent
Step 3.
Note that $R \to S$ is quasi-finite by
\rref{lemma-unramified-quasi-finite}.
By \rref{lemma-quasi-finite-open-integral-closure}
there exists a finite ring map $R \to S'$, an $R$-algebra map
$S' \to S$, an element $g' \in S'$ such that
$g' \not \in \mathfrak q$ such that $S' \to S$ induces
an isomorphism $S'_{g'} \cong S_{g'}$.
(Note that $S'$ may not unramified over $R$.)
Thus we may assume that (a) $R$ is Noetherian, (b) $R \to S$ is finite
and (c) $R \to S$ is unramified at $\mathfrak q$
(but no longer necessarily unramified at all primes).

\medskip\noindent
Step 4. Let $\mathfrak p \subset R$ be the prime corresponding
to $\mathfrak q$. Consider the fibre ring
$S \otimes_R \kappa(\mathfrak p)$. This is a finite algebra over
$\kappa(\mathfrak p)$. Hence it is Artinian
(see \rref{lemma-finite-dimensional-algebra}) and
so a finite product of local rings
$$
S \otimes_R \kappa(\mathfrak p) = \prod\nolimits_{i = 1}^n A_i
$$
see \rref{proposition-dimension-zero-ring}. One of the factors,
say $A_1$, is the local ring $S_{\mathfrak q}/\mathfrak pS_{\mathfrak q}$
which is isomorphic to $\kappa(\mathfrak q)$,
see \rref{lemma-unramified-at-prime}. The other factors correspond to
the other primes, say $\mathfrak q_2, \ldots, \mathfrak q_n$ of
$S$ lying over $\mathfrak p$.

\medskip\noindent
Step 5. We may choose a nonzero element $\alpha \in \kappa(\mathfrak q)$ which
generates the finite separable field extension
$\kappa(\mathfrak p) \subset \kappa(\mathfrak q)$ (so even if the
field extension is trivial we do not allow $\alpha = 0$).
Note that for any $\lambda \in \kappa(\mathfrak p)^*$ the
element $\lambda \alpha$ also generates $\kappa(\mathfrak q)$
over $\kappa(\mathfrak p)$. Consider the element
$$
\overline{t} =
(\alpha, 0, \ldots, 0) \in
\prod\nolimits_{i = 1}^n A_i =
S \otimes_R \kappa(\mathfrak p).
$$
After possibly replacing $\alpha$ by $\lambda \alpha$ as above
we may assume that $\overline{t}$ is the image of $t \in S$.
Let $I \subset R[x]$ be the kernel of the $R$-algebra
map $R[x] \to S$ which maps $x$ to $t$. Set $S' = R[x]/I$,
so $S' \subset S$. Here is a diagram
$$
\xymatrix{
R[x] \ar[r] & S' \ar[r] & S \\
R \ar[u] \ar[ru] \ar[rru] & &
}
$$
By construction the primes $\mathfrak q_j$, $j \geq 2$ of $S$ all
lie over the prime $(\mathfrak p, x)$ of $R[x]$, whereas
the prime $\mathfrak q$ lies over a different prime of $R[x]$
because $\alpha \not = 0$.

\medskip\noindent
Step 6. Denote $\mathfrak q' \subset S'$ the prime of $S'$
corresponding to $\mathfrak q$. By the above $\mathfrak q$ is
the only prime of $S$ lying over $\mathfrak q'$. Thus we see that
$S_{\mathfrak q} = S_{\mathfrak q'}$, see
\rref{lemma-unique-prime-over-localize-below} (we have
going up for $S' \to S$ by \rref{lemma-integral-going-up}
since $S' \to S$ is finite as $R \to S$ is finite).
It follows that $S'_{\mathfrak q'} \to S_{\mathfrak q}$ is finite
and injective as the localization of the finite injective ring map
$S' \to S$. Consider the maps of local rings
$$
R_{\mathfrak p} \to S'_{\mathfrak q'} \to S_{\mathfrak q}
$$
The second map is finite and injective. We have
$S_{\mathfrak q}/\mathfrak pS_{\mathfrak q} = \kappa(\mathfrak q)$,
see \rref{lemma-unramified-at-prime}.
Hence a fortiori
$S_{\mathfrak q}/\mathfrak q'S_{\mathfrak q} = \kappa(\mathfrak q)$.
Since
$$
\kappa(\mathfrak p) \subset \kappa(\mathfrak q') \subset \kappa(\mathfrak q)
$$
and since $\alpha$ is in the image of $\kappa(\mathfrak q')$ in
$\kappa(\mathfrak q)$
we conclude that $\kappa(\mathfrak q') = \kappa(\mathfrak q)$.
Hence by Nakayama's \rref{lemma-NAK} applied to the
$S'_{\mathfrak q'}$-module map $S'_{\mathfrak q'} \to S_{\mathfrak q}$,
the map $S'_{\mathfrak q'} \to S_{\mathfrak q}$ is surjective.
In other words,
$S'_{\mathfrak q'} \cong S_{\mathfrak q}$.

\medskip\noindent
Step 7. By \rref{lemma-local-isomorphism} there exists a $g' \in S'$,
$g' \not \in \mathfrak q'$ such that $S'_{g'} \cong S_{g'}$.
As $R$ is Noetherian the ring $S'$ is finite over $R$ as it is an $R$-submodule
of the finite $R$-module $S$. Hence after replacing $S$ by $S'$ we may
assume that (a) $R$ is Noetherian, (b) $S$ finite over $R$, (c)
$S$ is unramified over $R$ at $\mathfrak q$, and (d) $S = R[x]/I$.

\medskip\noindent
Step 8. Consider the ring
$S \otimes_R \kappa(\mathfrak p) = \kappa(\mathfrak p)[x]/\overline{I}$
where $\overline{I} = I \cdot \kappa(\mathfrak p)[x]$ is the ideal generated
by $I$ in $\kappa(\mathfrak p)[x]$. As $\kappa(\mathfrak p)[x]$ is a PID
we know that $\overline{I} = (\overline{h})$ for some monic
$\overline{h} \in \kappa(\mathfrak p)$. After replacing $\overline{h}$
by $\lambda \cdot \overline{h}$ for some $\lambda \in \kappa(\mathfrak p)$
we may assume that $\overline{h}$ is the image of some $h \in R[x]$.
(The problem is that we do not know if we may choose $h$ monic.)
Also, as in Step 4 we know that
$S \otimes_R \kappa(\mathfrak p) = A_1 \times \ldots \times A_n$ with
$A_1 = \kappa(\mathfrak q)$ a finite separable extension of
$\kappa(\mathfrak p)$ and $A_2, \ldots, A_n$ local. This implies
that
$$
\overline{h} = \overline{h}_1 \overline{h}_2^{e_2} \ldots \overline{h}_n^{e_n}
$$
for certain pairwise coprime irreducible monic polynomials
$\overline{h}_i \in \kappa(\mathfrak p)[x]$ and certain
$e_2, \ldots, e_n \geq 1$. Here the numbering is chosen so that
$A_i = \kappa(\mathfrak p)[x]/(\overline{h}_i^{e_i})$ as
$\kappa(\mathfrak p)[x]$-algebras. Note that $\overline{h}_1$ is
the minimal polynomial of $\alpha \in \kappa(\mathfrak q)$ and hence
is a separable polynomial (its derivative is prime to itself).

\medskip\noindent
Step 9. Let $m \in I$ be a monic element; such an element exists
because the ring extension $R \to R[x]/I$ is finite hence integral.
Denote $\overline{m}$ the image in $\kappa(\mathfrak p)[x]$.
We may factor
$$
\overline{m} = \overline{k}
\overline{h}_1^{d_1} \overline{h}_2^{d_2} \ldots \overline{h}_n^{d_n}
$$
for some $d_1 \geq 1$, $d_j \geq e_j$, $j = 2, \ldots, n$ and
$\overline{k} \in \kappa(\mathfrak p)[x]$ prime to all the $\overline{h}_i$.
Set $f = m^l + h$ where $l \deg(m) > \deg(h)$, and $l \geq 2$.
Then $f$ is monic as a polynomial over $R$. Also, the image $\overline{f}$
of $f$ in $\kappa(\mathfrak p)[x]$ factors as
$$
\overline{f} =
\overline{h}_1 \overline{h}_2^{e_2} \ldots \overline{h}_n^{e_n}
+
\overline{k}^l \overline{h}_1^{ld_1} \overline{h}_2^{ld_2}
\ldots \overline{h}_n^{ld_n}
=
\overline{h}_1(\overline{h}_2^{e_2} \ldots \overline{h}_n^{e_n}
+
\overline{k}^l
\overline{h}_1^{ld_1 - 1} \overline{h}_2^{ld_2} \ldots \overline{h}_n^{ld_n})
= \overline{h}_1 \overline{w}
$$
with $\overline{w}$ a polynomial relatively prime to $\overline{h}_1$.
Set $g = f'$ (the derivative with respect to $x$).

\medskip\noindent
Step 10. The ring map $R[x] \to S = R[x]/I$ has the properties:
(1) it maps $f$ to zero, and
(2) it maps $g$ to an element of $S \setminus \mathfrak q$.
The first assertion is clear since $f$ is an element of $I$.
For the second assertion we just have to show that $g$ does
not map to zero in
$\kappa(\mathfrak q) = \kappa(\mathfrak p)[x]/(\overline{h}_1)$.
The image of $g$ in $\kappa(\mathfrak p)[x]$ is the derivative
of $\overline{f}$. Thus (2) is clear because
$$
\overline{g} =
\frac{\text{d}\overline{f}}{\text{d}x} =
\overline{w}\frac{\text{d}\overline{h}_1}{\text{d}x} +
\overline{h}_1\frac{\text{d}\overline{w}}{\text{d}x},
$$
$\overline{w}$ is prime to $\overline{h}_1$ and
$\overline{h}_1$ is separable.

\medskip\noindent
Step 11.
We conclude that $\varphi : R[x]/(f) \to S$ is a surjective ring map,
$R[x]_g/(f)$ is \'etale over $R$ (because it is standard \'etale,
see \rref{lemma-standard-etale}) and $\varphi(g) \not \in \mathfrak q$.
Thus the map $(R[x]/(f))_g \to S_{\varphi(g)}$ is the desired
surjection.
\end{proof}



\begin{lemma}
\label{lemma-etale-makes-unramfied-closed-at-prime}
Let $R \to S$ be a ring map.
Let $\mathfrak q$ be a prime of $S$ lying over $\mathfrak p \subset R$.
Assume that $R \to S$ is of finite type and unramified at $\mathfrak q$.
Then there exist
\begin{enumerate}
\item an \'etale ring map $R \to R'$,
\item a prime $\mathfrak p' \subset R'$ lying over $\mathfrak p$.
\item a product decomposition
$$
R' \otimes_R S = A \times B
$$
\end{enumerate}
with the following properties
\begin{enumerate}
\item $R' \to A$ is surjective, and
\item $\mathfrak p'A$ is a prime of $A$ lying over $\mathfrak p'$ and
over $\mathfrak q$.
\end{enumerate}
\end{lemma}

\begin{proof}
We may replace $(R \to S, \mathfrak p, \mathfrak q)$
with any base change $(R' \to R'\otimes_R S, \mathfrak p', \mathfrak q')$
by a \'etale ring map $R \to R'$ with a prime $\mathfrak p'$
lying over $\mathfrak p$, and a choice of $\mathfrak q'$ lying over
both $\mathfrak q$ and $\mathfrak p'$. Note also that given
$R \to R'$ and $\mathfrak p'$ a suitable $\mathfrak q'$ can always
be found.

\medskip\noindent
The assumption that $R \to S$ is of finite type means that we may apply
\rref{lemma-etale-makes-quasi-finite-finite-variant}. Thus we may
assume that $S = A_1 \times \ldots \times A_n \times B$, that
each $R \to A_i$ is finite with exactly one prime $\mathfrak r_i$
lying over $\mathfrak p$ such that
$\kappa(\mathfrak p) \subset \kappa(\mathfrak r_i)$ is purely inseparable
and that $R \to B$ is not quasi-finite at any prime lying over $\mathfrak p$.
Then clearly $\mathfrak q = \mathfrak r_i$ for some $i$, since
an unramified morphism is quasi-finite
(see \rref{lemma-unramified-quasi-finite}).
Say $\mathfrak q = \mathfrak r_1$.
By \rref{lemma-unramified-at-prime} we see that
$\kappa(\mathfrak p) \subset \kappa(\mathfrak r_1)$
is separable hence the trivial field extension, and that
$\mathfrak p(A_1)_{\mathfrak r_1}$ is the maximal ideal.
Also, by \rref{lemma-unique-prime-over-localize-below}
(which applies to $R \to A_1$ because a finite ring map satisfies going up by
\rref{lemma-integral-going-up})
we have $(A_1)_{\mathfrak r_1} = (A_1)_{\mathfrak p}$.
It follows from Nakayama's \rref{lemma-NAK}
that the map of local rings
$R_{\mathfrak p} \to (A_1)_{\mathfrak p} = (A_1)_{\mathfrak r_1}$
is surjective. Since $A_1$ is finite over $R$ we see that there
exists a $f \in R$, $f \not \in \mathfrak p$ such that
$R_f \to (A_1)_f$ is surjective. After replacing $R$ by $R_f$ we win.
\end{proof}
