\chapter{Unique factorization and the class group}


Today, we will talk about unique factorization.

\subsection{Unique factorization}

Let $R$ be a domain.  
\begin{definition} 
A nonzero element $x \in R$ is \textbf{prime} if $(x)$ is a prime ideal.
\end{definition} 

In other words, $x$ is not a unit, and if $x \mid ab$, then either $x \mid a$
or $x \mid b$. 

\begin{definition} 
A domain $R$ is \textbf{factorial} if every nonzero noninvertible element $x \in R$ factors as a
product $ x_1 \dots x_n$ where each $x_i$ is prime. 
\end{definition}

A simple observation:
\begin{proposition} 
This factorization is essentially unique, that is up to multiplication by units.
\end{proposition} 
\begin{proof} Let $x \in R$ be a nonunit. 
Say $x = x_1 \dots x_n = y_1 \dots y_m$ were two different prime
factorizations. Then $m,n>0$. 

We have that $x_1 \mid y_1 \dots y_m$, so $x_1 \mid y_i$ for some $i$. But
$y_i$ is prime. So $x_1$ and $y_i$ differ by a unit. By removing each of these,
we can get  a smaller set of nonunique factorizations. 
Namely, we find that
\[ x_2 \dots x_n = y_1 \dots \hat{y_i} \dots y_m  \]
and then we can induct on the number of factors.
\end{proof} 

The motivating example is of course:
\begin{example} 
$\mathbb{Z}$ is factorial. This is the fundamental theorem of arithmetic. 
\end{example} 

\subsection{A ring-theoretic criterion}

\begin{definition} 
Let $R$ be a domain. A prime ideal $\mathfrak{p} \subset R$ is said to be of
\textbf{height one} if $\mathfrak{p}$ is minimal among ideals
containing $x$ for some nonzero $x \in R$. 
\end{definition} 
So a prime of height one is not the zero prime, but it is as close to zero as
possible, in some sense. When we later talk about dimension theory, we will
talk about primes of any height. In a sense, $\mathfrak{p}$ is ``almost''
generated by one element.

\begin{theorem} 
Let $R$ be a noetherian domain. The following are equivalent:
\begin{enumerate}
\item $R$ is factorial. 
\item Every height one prime is principal.
\end{enumerate}
\end{theorem} 
\begin{proof} 
Let's first show 1) implies 2). Assume $R$ is factorial and $\mathfrak{p}$ is
height one, minimal containing $(x)$ for some $x \neq 0 \in R$. 
Then $x$ is a nonunit, and it is nonzero, so it has a prime factorization
\[ x = x_1 \dots x_n, \quad \mathrm{each \ } x_i \ \mathrm{prime}.  \]
Some $x_i \in \mathfrak{p}$ because $\mathfrak{p}$ is prime. In particular,
\[ \mathfrak{p} \supset (x_i) \supset (x).  \]
But $(x_i)$ is prime itself, and it contains $(x)$. The minimality of
$\mathfrak{p}$ says that $\mathfrak{p}  = (x_i)$. 

Conversely, suppose every height one prime is principal. Let $x \in R$ be
nonzero and a nonunit. We want
to factor $x$ as a product of primes. 
Consider the ideal $(x) \subsetneq R$. As a result, $(x)$ is contained in a
prime ideal. Since $R$ is noetherian, there is a minimal prime ideal
$\mathfrak{p}$ containing $(x)$.  Then $\mathfrak{p}$, being a height one
prime, is principal---say $\mathfrak{p}=(x_1)$. It follows that $x_1 \mid x$
and $x_1$ is prime.
Say 
\[ x = x_1 x_1'.  \]
If $x_1'$ is a nonunit, repeat this process to get $x_1' = x_2 x_2'$ with $x_2$ a prime element. 
Keep going; inductively we have
\[ x_k = x_{k+1}x_{k+1}'.  \]
If this process stops, with one of the $x_k'$  a  unit, we get a prime
factorization of $x$. Suppose the process
continues forever. Then we would have
\[ (x) \subsetneq (x_1') \subsetneq (x_2') \subsetneq (x_3') \subsetneq \dots,  \]
which is impossible by noetherianness. 
\end{proof} 

We have seen that unique factorization can be formulated in terms of prime
ideals.

\subsection{Locally factorial domains}
\begin{definition} 
A noetherian domain $R$ is said to be \textbf{locally factorial} if
$R_{\mathfrak{p}}$ is factorial for each $\mathfrak{p}$ prime.
\end{definition} 

\begin{example} 
The coordinate ring $\mathbb{C}[x_1, \dots, x_n/I$ of an algebraic variety is
locally factorial if the variety is smooth. We may talk about this later. 
\end{example} 

\begin{example}[Nonexample]
Let $R$ be $\mathbb{C}[A,B,C,D]/(AD - BC)$. The spectrum of $R$ has maximal
ideals consisting of 2-by-2 matrices of determinant zero. This variety is very
singular at the origin. It is not even locally factorial at the origin.

The failure of unique factorization comes from the fact that
\[ AD = BC  \]
in this ring $R$. This is a protypical example of a ring without unique
factorization. The reason has to do with the fact that the variety has a
singularity at the origin. 
\end{example} 

\subsection{The Picard group}

\begin{definition} 
Let $R$ be a commutative ring. An $R$-module $I$ is \textbf{invertible} if
there exists $J$ such that
\[ I \otimes_R J \simeq R.  \]
Invertibility  is with respect to the tensor product.
\end{definition} 

\begin{remark} 
You're supposed to think of a module as giving something like a vector bundle
on $\spec R$. An invertible module looks like a line bundle on $\spec R$.
\end{remark} 

There are many equivalent characterizations.

\begin{proposition} 
Let $R$ be a ring, $I$ an $R$-module. TFAE:
\begin{enumerate}
\item $I$ is invertible.   
\item $I$ is finitely generated and $I_{\mathfrak{p}} \simeq R_{\mathfrak{p}}$ for all primes
$\mathfrak{p} \subset R$.
\item $I$ is finitely generated and there exist $a_1, \dots, a_n \in R$ which generate $(1)$
in $R$ such that
\[ I[a_i^{-1}]\simeq R[a_i^{-1}].  \]
\end{enumerate}
\end{proposition} 
\begin{proof} 
First, we show that if $I$ is invertible, then $I$ is finitely generated 
Suppose $I \otimes_R J \simeq R$. This means that $1 \in R$ corresponds to an
element
\[ \sum i_k \otimes j_k \in I \otimes_R J .  \]
Thus, there exists a finitely generated submodule $I_0\subset I$ such that the map $I_0 \otimes J \to I
\otimes J$ is surjective. Tensor this with $I$, so we get a surjection
\[ I_0 \simeq I_0 \otimes J \otimes I \to I \otimes J \otimes I \simeq I  \]
which leads to a surjection $I_0 \twoheadrightarrow I$. This implies that $I$
is finitely generated 


We now show 1 implies 2. Note that if $I$ is invertible, then $I \otimes_R R'$
is an invertible $R'$ module for any $R$-algebra $R'$; to get an inverse,
tensor the inverse of $I$ with $R'$.
In particular, $I_{\mathfrak{p}}$ is an invertible $R_{\mathfrak{p}}$-module
for each $\mathfrak{p}$. As a result, 
\[ I_{\mathfrak{p}}/\mathfrak{p} I_{\mathfrak{p}}  \]
is invertible over $R_{\mathfrak{p}}/\mathfrak{p}R_{\mathfrak{p}}$. This means
that 
$ I_{\mathfrak{p}}/\mathfrak{p} I_{\mathfrak{p}}$ is a one-dimensional vector
space over the residue field. (The invertible modules over a vector space are
the one-dimensional spaces.)
Choose an element $x \in I_{\mathfrak{p}}$ which generates
$I_{\mathfrak{p}}/\mathfrak{p}I_{\mathfrak{p}}$.  Since $I_{\mathfrak{p}}$ is
finitely generated, this shows that $x$ generates $I_{\mathfrak{p}}$.

We get a surjection $\alpha: R_{\mathfrak{p}} \twoheadrightarrow I_{\mathfrak{p}}$
carrying $1 \to x$.  I claim that:
\begin{quote}
This map is injective.
\end{quote}
This will imply that $I_{\mathfrak{p}}$ is free of rank 1. Well, let $J$ be an
inverse of $I$ in $R$-modules; the same argument provides a surjection
$ \beta: {R}_{\mathfrak{p}} \to J_{\mathfrak{p}}$. We get a map
\[ R_{\mathfrak{p}} \stackrel{\alpha}{\twoheadrightarrow} I_{\mathfrak{p}}
\stackrel{\beta'}{\twoheadrightarrow} R_{\mathfrak{p}}  \]
(where $\beta = \beta \otimes 1_{I_{\mathfrak{p}}}$)
whose composite must be multiplication by a unit, since the ring is local. Thus
the composite is injective and $\alpha$ is injective. 

Now we show 2 implies 3. Suppose $I$ is finitely generated and $I_{\mathfrak{p}} \simeq
R_{\mathfrak{p}}$ for all $\mathfrak{p}$. I claim that for each $\mathfrak{p}
$, we can choose an element $x$ of $I_{\mathfrak{p}}$ generating $I_{\mathfrak{p}}$. 
By multiplying by the denominator, we can assume that $x \in I$. 
Then if $\left\{x_1, \dots, x_n\right\} \subset I$ generates $I$, then we have
equalities
\[ s_i x_i = a_i x \in R  \]
for some $s_i \notin \mathfrak{p}$ as $x$ generates $I_{\mathfrak{p}}$. This means that $x$ generates $I$ after inverting the $s_i$. It
follows that $I[1/a] = R[1/a]$ where $a = \prod s_i \notin \mathfrak{p}$.
In particular, we find that there is an open covering $\{\spec
R[1/a_{\mathfrak{p}}] \}$ of $\spec R$ (where $a_{\mathfrak{p}} \notin
\mathfrak{p}$) on which $I$ is isomorphic to $R$. 
To say that these cover $\spec R$ is to say that the $a_{\mathfrak{p}}$
generate $1$. 

Finally, let's do the implication 3 implies 1.  Assume that we have the
situation of $I[1/a_i] \simeq R[1/a_i]$. We want to show that $I$ is invertible. 
We start by showing that $I$ is \textbf{finitely presented}. This means that
there is an exact sequence
\[ R^m \to R^n \to I \to 0,  \]
i.e. $I$ is the cokernel of a map between free modules of finite rank.
To see this, first, we've assumed that $I$ is finitely generated. So there is a
surjection
\[ R^n \twoheadrightarrow I  \]
with a kernel $K \rightarrowtail  R^n$. We must show that $K$ is finitely
generated. Localization is an exact functor, so $K[1/a_i]$ is the kernel of
$R[1/a_i]^n \to I[1/a_i]$. However, we have an exact sequence
\[ K[1/a_i] \rightarrowtail  R[1/a_i]^n \twoheadrightarrow R[1/a_i]  \]
by the assumed isomorphism $I[1/a_i] \simeq R[1/a_i]$. But since a free module
is projective, this sequence splits and we find that $K[1/a_i]$ is finitely
generated. If it's finitely generated, it's generated by finitely many elements
in $K$. 
As a result, we find that there is a map
\[ R^N \to K  \]
such that the localization to $\spec R[1/a_i]$ is surjective. This implies by
the homework that $R^N \to K$ is surjective.\footnote{To check that a map is
surjective, just check at the localizations at any maximal ideal.} Thus $K$ is finitely generated. 

In any case, we have shown that the module $I$ is finitely presented.
\textbf{Define} $J = \hom_R(I, R)$ as the candidate for its dual. This
construction is compatible with localization.
We can choose a finite presentation $R^m \to R^n \to I \to 0$, which leads to a
sequence
\[ 0 \to J \to \hom(R^n, R) \to \hom(R^m, R).  \]
It follows that the formation of $J$ commutes with localization. 
In particular, this argument shows that
\[ J[1/a] = \hom_{R[1/a]}(I[1/a], R[1/a]).  \]
One can check this by using the description of $J$. By construction, there is a
canonical map $I \otimes J \to R$. 
I claim that this map is invertible.

For the proof, we use the fact that one can check for an isomorphism locally.  
It suffices to show that 
\[ I[1/a] \otimes J[1/a] \to R[1/a]  \]
is an isomorphism for some collection of $a$'s that generate the unit ideal.
However, we have $a_1, \dots, a_n$ that generate the unit ideal such that
$I[1/a_i]$ is free of rank 1, hence so is $J[1/a_i]$. It thus follows that
$I[1/a_i] \otimes J[1/a_i]$ is an isomorphism.
\end{proof} 


\begin{definition} 
Let $R$ be a commutative ring. We define the \textbf{Picard group} $\pic(R)$ to
be the set of isomorphism classes of invertible $R$-modules. This is an abelian group
under the tensor product; the identity element is given by $R$. 
\end{definition} 

Next time, we will continue talking about the Picard group and how it controls
the failure of unique factorization.

\lecture{10/8}

Last time, for a commutative ring $R$, we defined the \textbf{Picard group}
$\pic(R)$ as the set of isomorphism classes of invertible $R$-modules. The
group structure is given by the tensor product.

\subsection{Cartier divisors}

Assume furthermore that $R$ is a domain. We now introduce:

\begin{definition} 
A \textbf{Cartier divisor} for $R$ is a submodule $M \subset K(R)$ such that
$M$ is invertible. 
\end{definition} 
In other words, a Cartier divisor is an invertible fractional ideal.
Alternatively, it is an invertible $R$-module $M$ with a nonzero map $M \to
K(R)$. \textbf{ Once this map is nonzero, it is automatically injective,} since
injectivity can be checked at the localizations, and any module-homomorphism from a domain into
its quotient field is either zero or injective (because it is multiplication by
some element). 


We now make this into a group. 
\begin{definition} 
Given $(M, a: M \hookrightarrow K(R))$ and $(N, b: N \hookrightarrow K(R))$, we
define the sum to be 
\[  (M \otimes N, a \otimes b: M \otimes N \hookrightarrow K(R)). \]
The map $a \otimes b$ is nonzero, so by what was said above, it is an injection.
Thus the Cartier divisors from an abelian group $\cart(R)$.
\end{definition} 

By assumption, there is a homomorphism
\[ \cart(R) \to\pic(R)  \]
mapping $(M, M \hookrightarrow K(R)) \to M$. 

\begin{proposition} 
The map $\cart(R) \to \pic(R)$ is surjective. In other words, any invertible
$R$-module can be embedded in $K(R)$.
\end{proposition} 
\begin{proof}  Let $M$ be an invertible $R$-module.
Indeed, we know that $M_{(0)} = M \otimes_R K(R)$ is an invertible
$K(R)$-module, so a one-dimensional vector space over $K(R)$. In particular,
$M_{(0)} \simeq K(R)$. There is a nonzero homomorphic map
\[  M \to M_{(0) } \simeq K(R),  \]
which is automatically injective by the discussion above. 
\end{proof} 

What is the kernel of $\cart(R) \to \pic(R)$? This is the set of Cartier divisors which are
isomorphic to $R$ itself. In other words, it is the set of $(R, R
\hookrightarrow K(R))$. This data is the same thing as the data of a nonzero
element of $K(R)$. 
So the kernel of 
\[  \cart(R) \to \pic(R)  \]
has kernel isomorphic to $K(R)^*$. We have a short exact sequence
\[  K(R)^* \to \cart(R) \to \pic(R) \to 0.  \]

\subsection{Weil divisors and Cartier divisors}

Now, we want to assume $\cart(R)$ if $R$ is ``good.'' The ``goodness'' in
question is to assume that $R$ is locally factorial, i.e. that
$R_{\mathfrak{p}}$ is factorial for each $\mathfrak{p}$. This is true, for
instance, if $R$ is the coordinate ring of a smooth algebraic variety.



\begin{proposition} 
If $R$ is locally factorial and noetherian, then the group $\cart(R)$ is a free abelian group.
The generators are in bijection with the height one primes of $R$.
\end{proposition} 

We start by discussing Weil divisors.
\begin{definition} 
A \textbf{Weil divisor} for $R$ is a formal linear combination $\sum n_{i}
[\mathfrak{p}_i]$ where the $\mathfrak{p}_i$ range over height one primes of
$R$. So the group of Weil divisors is the free abelian group on the height one
primes of $R$. We denote this group by $\weil(R)$.
\end{definition} 

Now assume that $R$ is a locally factorial, noetherian domain. 
We shall produce an isomorphism
\[ \weil(R) \simeq \cart(R)  \]
that sends $[\mathfrak{p}_i]$ to that height one prime $\mathfrak{p}_i$
together with the imbedding $\mathfrak{p}_i \hookrightarrow R \to K(R)$. 

We first check that this is well-defined. Since $\weil(R)$ is free, all we have
to do is check that each $\mathfrak{p}_i$ is a legitimate Cartier divisor. In
other words, we need to show that:

\begin{proposition} 
If $\mathfrak{p} \subset R$ is a height one prime and $R$ locally factorial, then $\mathfrak{p}$ is
invertible. 
\end{proposition} 
\begin{proof} 
In the last lecture, we gave a criterion for invertibility: namely, being
locally trivial. We have to show that for any prime $\mathfrak{q}$, we have
that $\mathfrak{p}_{\mathfrak{q}}$ is isomorphic to $R_{\mathfrak{q}}$. If
$\mathfrak{p} \not\subset \mathfrak{q}$, then $\mathfrak{p}_{\mathfrak{q}}$ is
the entire ring $R_{\mathfrak{q}}$, so this is obvious. Conversely, suppose
$\mathfrak{p} \subset {\mathfrak{q}}$. Then $\mathfrak{p}_{\mathfrak{q}}$ is
a height one prime of $R_{\mathfrak{q}}$: it is minimal over some element in
$R_{\mathfrak{q}}$. 

Thus $\mathfrak{p}_{\mathfrak{q}}$ is principal, in particular free of rank
one, since $R_{\mathfrak{q}}$ is factorial. We saw last time that being
factorial is equivalent to the principalness of height one primes. 
\end{proof} 

We need to define the inverse map
\[ \cart(R) \to \weil(R).  \]
In order to do this, start with a Cartier divisor $(M, M \hookrightarrow
K(R))$. We then have to describe which coefficient to assign a height one
prime. To do this, we use a local criterion. 

Let's first digress a bit.
Consider a locally factorial domain $R$ and a prime $\mathfrak{p}$ of height
one. Then $R_{\mathfrak{p}}$ is factorial. In particular, its maximal ideal
$\mathfrak{p}R_{\mathfrak{p}}$ is height one, so principal. 
It is the principal ideal generated by some $t \in R_{\mathfrak{p}}$. 
Now we show:
\begin{proposition} 
Every nonzero ideal in $R_{\mathfrak{p}}$ is of the form $(t^n)$ for some unique $n
\geq 0$.
\end{proposition} 
\begin{proof} 
Let $I_0 \subset R_{\mathfrak{p}}$ be nonzero.  If $I_0 = R_{\mathfrak{p}}$, then
we're done---it's generated by $t^0$. Otherwise, $I_0 \subsetneq
R_{\mathfrak{p}}$, so contained in $\mathfrak{p}R_{\mathfrak{p}} = (t)$. So let
$I_1 = \left\{x \in R_{\mathfrak{p}}: tx \in I_0\right\}$. Thus 
\[ I_1 = t^{-1} I_0.  \]
I claim now that $I_1 \neq I_0$, i.e. that there exists $x \in R_{\mathfrak{p}}$ such that $x
\notin I_0$ but $tx \in I_0$. The proof comes from the theory of associated
primes.
Look at $R_{\mathfrak{p}}/I_0$; it has at least one associated prime as it is
nonzero. 

Since it
is a torsion module, this associated prime must be
$\mathfrak{p}R_{\mathfrak{p}}$ since the only primes in $R_{\mathfrak{p}}$
are $(0)$ and $(t)$, \textbf{which we have not yet shown}.  So there exists an
element in the quotient $R/I_0$ whose annihilator is precisely $(t)$. Lifting
this gives an element in $R$ which when multiplied by $(t)$ is in $I_0$ but
which is not in $I_0$. So $I_0 \subsetneq I_1$.

Proceed as before now. Define $I_2 = \left\{x  \in R_{\mathfrak{p}}: tx \in
I_1\right\}$.  This process must halt since we have assumed noetherianness. We
must have $I_m = I_{m+1}$ for some $m$, which would imply that some $I_m =
R_{\mathfrak{p}}$ by the above argument. It then follows that $I_0 = (t^m)$
since each $I_i$ is just $t I_{i+1}$. 
\end{proof} 

We thus have a good structure theory for ideals in $R$ localized at a height one prime.
Let us make a more general claim.

\begin{proposition} 
Every nonzero finitely generated $R_{\mathfrak{p}}$-submodule of the fraction field $K(R)$ is of the
form $(t^n)$ for some $n \in \mathbb{Z}$.
\end{proposition} 
\begin{proof} 
Say that $M \subset K(R)$ is such a submodule. Let $I = \left\{x \in
R_{\mathfrak{p}}, x M \subset R_{\mathfrak{p}}\right\}$. Then $I \neq 0$ as $M$
is finitely generated  $M$ is generated over $R_{\mathfrak{p}}$ by a finite number of fractions $a_i/b_i, b_i \in R$.
Then the product $b = \prod b_i$ brings $M$ into $R_{\mathfrak{p}}$. 

We know that $I = (t^m) $ for some $m$. In particular, $t^m M$ is an ideal in
$R$. In particular, 
\[ t^m M = t^p R  \]
for some $p$, in particular $M = t^{p-m}R$. 

\end{proof} 

Now let's go back to the main discussion. $R$ is a noetherian locally factorial
domain; we want to construct a map
\[ \cart(R) \to \weil(R).  \]
Given $(M, M \hookrightarrow K(R))$ with $M$ invertible, we want to define a
formal sum $\sum n_i [\mathfrak{p}_i]$. For every height one prime
$\mathfrak{p}$, let us look at the local ring $R_{\mathfrak{p}}$ with maximal
ideal generated by some $t_{\mathfrak{p}} \in R_{\mathfrak{p}}$. Now
$M_{\mathfrak{p}} \subset K(R)$ is a finitely generated
$R_{\mathfrak{p}}$-submodule, so generated by some
$t_{\mathfrak{p}}^{n_{\mathfrak{p}}}$. So we map $(M, M \hookrightarrow K(R))$
to 
\[ \sum_{\mathfrak{p}} n_{\mathfrak{p}}[\mathfrak{p}]. \]
First, we have to check that this is well-defined. In particular, we have to
show:

\begin{proposition} 
For almost all height one $\mathfrak{p}$, we have $M_{\mathfrak{p}} =
R_{\mathfrak{p}}$. In other words, the integers $n_{\mathfrak{p}}$ are almost all zero.
\end{proposition} 
\begin{proof} 
We can always assume that $M$ is actually an ideal. Indeed, choose $a \in R$
with $aM = I \subset R$. As Cartier divisors, we have $M  = I  - (a)$. If we
prove the result for $I$ and $(a)$, then we will have proved it for $M$ (note
that the $n_{\mathfrak{p}}$'s are additive invariants\footnote{To see this,
localize at $\mathfrak{p}$---then if $M$ is generated by $t^a$, $N$ generated
by $t^b$, then $M \otimes N$ is generated by $t^{a+b}$.}). So because of this
additivity, it is sufficient to prove the proposition for actual (i.e.
nonfractional) ideals.

Assume thus that $M \subset R$.
All of these $n_{\mathfrak{p}}$ associated to $M$ are at least zero because $M$
is actually an ideal. What we want is that $n_{\mathfrak{p}} \leq 0$ for almost
all $\mathfrak{p}$. In other words, we must show that
\[ M_{\mathfrak{p}} \supset R_{\mathfrak{p}} \quad \mathrm{almost \ all \ }
\mathfrak{p}.  \]
To do this, just choose any $x \in M - 0$. There are finitely many minimal
primes containing $(x)$ (by primary decomposition applied to $R/(x)$). Every
other height one prime $\mathfrak{q}$ does not contain $(x)$.\footnote{Again, we're using
something about height one primes not proved yet.}
This states that $M_{\mathfrak{q}} \supset x/x = 1$, so $M_{\mathfrak{q}}
\supset R_{\mathfrak{q}}$.

The key claim we've used in this proof is the following. If $\mathfrak{q}$ is a 
height one prime in a domain $R$ containing some nonzero element $(x)$, then
$\mathfrak{q}$ is minimal among primes containing $(x)$. In other words, we can
test the height one condition at any nonzero element in that prime.
Alternatively:
\begin{lemma} 
There are no nontrivial containments among height one primes.
\end{lemma} 
\end{proof} 

Anyway, we have constructed maps between $\cart(R) $ and $\weil(R)$. The map
$\cart(R) \to \weil(R)$ takes $M \to \sum n_{\mathfrak{p}}[\mathfrak{p}]$. The
other map $\weil(R) \to \cart(R)$ takes $[\mathfrak{p}] \to \mathfrak{p}
\subset K(R)$. The composition $\weil(R) \to \weil(R)$ is the identity. Why is that? Start with a
prime $\mathfrak{p}$; that goes to the Cartier divisor $\mathfrak{p}$. Then we
need to finitely generatedre the multiplicities at other height one primes. But if
$\mathfrak{p}$ is height one and $\mathfrak{q}$ is a height one prime, then if
$\mathfrak{p} \neq \mathfrak{q}$ the lack of nontrivial containment relations
implies that the multiplicity of $\mathfrak{p}$ at $\mathfrak{q}$ is zero. We
have shown that
\[  \weil(R) \to \cart(R) \to \weil(R)  \]
is the identity.

Now we have to show that $\cart(R) \to \weil(R)$ is injective. Say we have a
Cartier divisor $(M, M \hookrightarrow K(R))$ that maps to zero in $\weil(R)$,
i.e. all its multiplicities
$n_{\mathfrak{p}}$ are zero at height one primes. 
We show that $M  = R$. 

First, assume $M \subset R$. 
It is sufficient to show that at any maximal ideal $\mathfrak{m} \subset R$, we
have
\[ M_{\mathfrak{m}} = R_{\mathfrak{m}}.  \]
What can we say? Well, $M_{\mathfrak{m}}$ is principal as $M$ is invertible,
being a Cartier divisor. Let it be generated by $x \in R_{\mathfrak{m}}$;
suppose $x$ is a nonunit (or we're already done). But
$R_{\mathfrak{m}}$ is factorial, so $x = x_1 \dots x_n$ for each $x_i $ prime.
If $n>0$, then however $M$ has nonzero multiplicity at the prime ideal  $(x_i) \subset
R_{\mathfrak{m}} $. This is a contradiction. 

The general case of $M$ not really a  subset of $R$ can be handled similarly:
then the generating element $x$ might lie in the fraction field. So $x$, if it
is not a unit in $R$, is a
product of some primes in the numerator and some primes in the denominator. 
The nonzero primes that occur lead to nonzero multiplicities. 
\lecture{10/13}

\subsection{Recap and a loose end}

Last time, it was claimed that if $R$ is a locally factorial domain, and
$\mathfrak{p} \subset R$ is of height one, then every prime ideal of
$R_{\mathfrak{p}}$ is either maximal or zero. This follows from general
dimension theory. This is equivalent to the following general claim about
height one primes:

\begin{quote}
There are no nontrivial inclusions among height one primes for $R$ a locally
factorial domain. 
\end{quote}

\begin{proof}  Suppose $\mathfrak{q} \subsetneq \mathfrak{p}$ is an inclusion
of height one primes. 

Replace $R$ by $R_{\mathfrak{p}}$. Then $R$ is local with some maximal ideal
$\mathfrak{m}$, which is principal with some generator $x$.  
Then we have an inclusion 
\[ 0 \subset \mathfrak{q} \subset \mathfrak{m}.  \]
This inclusion is proper. However, $\mathfrak{q}$ is principal since
it is height one in the factorial ring $R_{\mathfrak{p}}$.
This cannot be since every element is a power of $x$ times a unit.
(Alright, this wasn't live \TeX ed well.)
\end{proof} 

Last time, we were talking about $\weil(R)$ and $\cart(R)$ for $R$ a locally
factorial noetherian domain.
\begin{enumerate}
\item $\weil(R)$ is free on the height one primes. 
\item $\cart(R)$ is the group of invertible submodules of $K(R)$.
\end{enumerate}
We produced an isomorphism
\[ \weil(R) \simeq \cart(R).  \]

\begin{remark} 
Geometrically, what is this? Suppose $R = \mathbb{C}[X_1, \dots, X_n]/I$ for
some ideal $I$. Then the maximal ideals, or closed points in $\spec R$, are
certain points in $\mathbb{C}^n$; they form an irreducible variety if $R$ is
a domain. The locally factorial condition is satisfied, for instance, if the
variety is \emph{smooth}. In this case, the Weil divisors correspond to sums of 
irreducible varieties of codimension one---which correspond to the primes of
height one. The Weil divisors are free on the set
of irreducible varieties of codimension one.  

The Cartier divisors can be thought of as ``linear combinations'' of
subvarieties which are locally defined by one equation. It is natural to assume
that the condition of being defined by one equation corresponds to being
codimension one. This is true by the condition of $R$ locally factorial.

In general, we can always construct a map
\[ \cart(R) \to \weil(R),  \]
but it is not necessarily an isomorphism. 


\end{remark} 

\subsection{Further remarks on $\weil(R)$ and $\cart(R)$} Recall that the Cartier group fits in an exact sequence:
\[  K(R)^* \to \cart(R) \to \pic(R) \to 0,   \]
because every element of $\cart(R)$ determines its isomorphism class, and
every element of $K(R)^*$ determines a free module of rank one. Contrary
to what was stated last time, it is \textbf{not true} that exactness holds on
the right. In fact, the kernel is the group $R^*$ of units of $R$. So the exact
sequence runs
\[ 0 \to R^* \to K(R)^* \to  \cart(R) \to \pic(R) \to 0.  \]
This is true for \emph{any} domain $R$. For $R$ locally factorial and
noetherian, we know that $\cart(R) \simeq \weil(R)$, though. 

We can think of this as a generalization of unique factorization. 
\begin{proposition} 
$R$ is factorial if and only if $R$ is locally factorial and $\pic(R) = 0$.
\end{proposition} 
\begin{proof} 
Assume $R$ is locally factorial and $\pic(R)=0$. Then every prime ideal of
height one (an element of $\weil(R)$, hence of $\cart(R)$) is principal, which
implies that $R$ is factorial. And conversely.
\end{proof} 

In general, we can think of the exact sequence above as a form of unique
factorization for a locally factorial domain: any invertible fractional ideal is a product of height one prime
ideals. 

Let us now give an example.

\subsection{Discrete valuation rings and Dedekind rings}
\begin{example} 
Let $R$ be a noetherian local domain whose prime ideals are $(0)$ and the maximal
ideal 
$\mathfrak{m} \neq 0$. In this condition, I claim:
\begin{proposition} 
TFAE:
\begin{enumerate}
\item $R$ is factorial.
\item $\mathfrak{m}$ is principal.
\item  $R$ is integrally closed.
\item $R$ is a valuation ring with value group $\mathbb{Z}$. 
\end{enumerate}
\end{proposition} 
\begin{definition} 
A ring satisfying these conditions is called a \textbf{discrete valuation
ring} (\textbf{DVR}).
A discrete valuation ring necessarily has only two prime ideals. In fact, a
valuation ring with value group $\mathbb{Z}$ satisfies all the above conditions. 
\end{definition} 
\begin{proof} 
Suppose $R$ is factorial. Then every prime ideal of height one is principal.
But $\mathfrak{m}$ is the only prime that can be height one (it's minimal over
any nonzero nonunit of $R$. Thus 1 implies 2, and similarly 2 implies 1.

1 implies 3 is true for any $R$: factorialness implies integrally closedness.
This is either either homework on the problem set or an easy exercise one can
do for yourself. 

4 implies 2 because one chooses an element $x \in R$ such that the valuation of
$x$ is one. Then, it is easy to see that $x$ generates $\mathfrak{m}$: if $y
\in \mathfrak{m}$, then the valuation of $y$ is at least one, so $y/x \in R$
and $y = (y/x)x \in (x)$. 

The implication 2 implies 4 was essentially done last time. Suppose
$\mathfrak{m}$ is principal, generated by $t$. Last time, we saw that
\emph{all} nonzero ideals of $R$ have the form $(t^n)$ for some $n>0$.  If $x
\in R$, we define the valuation of $x$ to be $n$ if $(x) = (t^n)$. One can
easily check that this is a valuation on $R$ which extends to the quotient
field by additivity.

The interesting part of the argument is the claim that 3
implies 2. Suppose $R$ is integrally closed; I claim that $\mathfrak{m}$ is
principal. Choose $x \in \mathfrak{m} - \left\{0\right\}$. If $(x) =
\mathfrak{m}$, we're done. Otherwise, we can look at $\mathfrak{m}/(x) \neq
0$.  We have a finitely generated module over a noetherian ring which is
nonzero, so it has an associated prime. That associated prime is either zero or
$\mathfrak{m}$. But $0$ is not an associated prime because every element in the
module is killed by $x$. So $\mathfrak{m}$ is an associated prime.

Thus, there is $y \in \mathfrak{m}$ such that $y \notin (x)$ and $\mathfrak{m}y
\subset (x)$. In particular, $y/x \in K(R) - R$ but
\[ (y/x) \mathfrak{m} \subset R.  \]
There are two cases:
\begin{enumerate}
\item Suppose $(y/x) \mathfrak{m}  = R$. Then we can write $\mathfrak{m} =
R(x/y)$. So $\mathfrak{m}$ is principal. (This argument shows that $x/y \in R$.)	
\item The other possibility is that $y/x \mathfrak{m} \subsetneq R$. In this
case, this is an ideal, so 
\[ (y/x) \mathfrak{m} \subset \mathfrak{m}.  \]
In particular, multiplication by $y/x$ carries $\mathfrak{m}$ to itself.  So
multiplication by $y/x$ stabilizes the finitely generated module
$\mathfrak{m}$. By the usual characteristic polynomial argument, we see that
$y/x$ is integral over $R$. In particular, $y/x \in R$, as $R$
was integrally closed, a contradiction as $y \notin (x)$. 
\end{enumerate}
\end{proof} 

We now introduce a closely related notion.  
\begin{definition} 
A \textbf{Dedekind ring} is a noetherian domain $R$ such that 
\begin{enumerate}
\item $R$ is integrally closed.
\item Every nonzero prime ideal of $R$ is maximal. 
\end{enumerate}
\end{definition} 
\end{example} 


\begin{remark} 
If $R$ is Dedekind, then any nonzero element is height one. This is evident
since every nonzero prime is maximal. 

If $R$ is Dedekind, then $R$ is locally factorial. In fact, the localization of
$R$ at a nonzero prime $\mathfrak{p}$ is a DVR.
\begin{proof} 
$R_{\mathfrak{p}}$ has precisely two prime ideals: $(0)$ and
$\mathfrak{p}R_{\mathfrak{p}}$. As a localization of an integrally closed
domain, it is integrally closed. So $R_{\mathfrak{p}}$ is a DVR by the above
result (hence
factorial).
\end{proof} 
\end{remark} 


Assume $R$ is Dedekind now.
We have an exact sequence
\[ 0 \to R^* \to K(R)^* \to \cart(R) \to \pic(R) \to 0.  \]
Here $\cart(R) \simeq \weil(R)$. But $\weil(R)$ is free on the nonzero
primes, or equivalently maximal ideals, $R$ being Dedekind. 
In fact, however, $\cart(R)$ has a simpler description.

\begin{proposition} 
Suppose $R$ is Dedekind. Then $\cart(R)$ consists of all nonzero finitely generated
submodules of $K(R)$ (i.e. \textbf{fractional ideals}). 
\end{proposition} 

This is the same thing as saying as every nonzero finitely generated submodule of $K(R)$ is
invertible.
\begin{proof} 
Suppose $M \subset K(R)$ is nonzero and finitely generated It suffices to check that $M$ is
invertible after localizing at every prime, i.e. that $M_{\mathfrak{p}}$ is
an invertible---or equivalently, trivial, $R_{\mathfrak{p}}$-module. At the
zero prime, there is nothing to check. We might as well assume that
$\mathfrak{p}$ is maximal. Then $R_{\mathfrak{p}}$ is a DVR and
$M_{\mathfrak{p}}$ is a finitely generated submodule of $K(R_{\mathfrak{p}}) = K(R)$. 

Let $S$ be the set of integers $n$ such that there exists $ x \in
M_{\mathfrak{p}}$ with $v(x) = n$, for $v$ the valuation of $R_{\mathfrak{p}}$.
By finite generation of $M$, $S$ is bounded below. Thus $S$ has a least element
$k$. There is an element of $M_{\mathfrak{p}}$, call it $x$, with valuation $k$.

It is easy to check that $M_{\mathfrak{p}}$ is generated by $x$, and is in fact free with
generator $x$. The reason is simply that $x$ has the smallest valuation of
anything in $M_{\mathfrak{p}}$.
\end{proof} 

What's the upshot of this?

\begin{theorem}
If $R$ is a Dedekind ring, then any nonzero ideal $I \subset R$ is invertible,
and therefore uniquely described as a product of powers of (nonzero) prime ideals, $I =
\prod \mathfrak{p}_i^{n_i}$.
\end{theorem} 
\begin{proof} 
This is simply because $I$ is in $\cart(R) = \weil(R)$ by the above result. 
\end{proof} 

This is Dedekind's generalization of unique factorization.

We now give the standard examples:
\begin{example} 
\begin{enumerate}
\item Any PID is Dedekind.  
\item If $K$ is a finite extension of $\mathbb{Q}$, and set $R $ to be the
integral closure of $\mathbb{Z}$ in $K$, then $R$ is a Dedekind ring. The ring
of integers in any number field is a Dedekind ring. 
\item If $R$ is the coordinate ring of an algebraic variety which is smooth and
irreducible of dimension one, then $R$ is Dedekind. 
\item  Let $X$ be a compact Riemann surface, and let $S \subset X$ be a
nonempty finite subset. Then the ring of meromorphic functions on $X$ with
poles only in $S$ is
Dedekind. The maximal ideals in this ring are precisely those corresponding to
points of $X-S$. 
\end{enumerate}
\end{example} 

